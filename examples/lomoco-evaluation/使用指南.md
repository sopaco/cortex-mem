# Cortex Mem 评估系统使用指南

## 系统概述

Cortex Mem 评估系统是一个完整的内存技术评估框架，专门用于测试和比较 cortex-mem 与其他内存技术的性能。

## 文件结构

### 核心组件
- `dataset/locomo10.json` - LOCOMO 数据集 (原始格式)
- `dataset/locomo10_rag.json` - LOCOMO 数据集 (RAG 格式)
- `config.toml` - Cortex Mem 配置文件
- `.env` - 环境变量配置

### Python 模块
- `src/cortex_mem/` - Cortex Mem 评估模块
  - `add.py` - 记忆添加实现
  - `search.py` - 记忆搜索实现
  - `config_utils.py` - 配置工具

### 评估脚本
- `run_cortex_mem_evaluation.py` - 专用 Cortex Mem 评估
- `test_cortex_mem_simple.py` - 基础功能测试
- `test_cortex_mem_integration.py` - 集成测试
- `verify_datasets.py` - 数据集验证

### 评估工具
- `evals.py` - 评估指标计算
- `generate_scores.py` - 评分报告生成

## 快速开始

### 1. 系统验证
```bash
# 验证所有组件
python test_cortex_mem_simple.py

# 集成测试
python test_cortex_mem_integration.py

# 验证数据集
python verify_datasets.py
```

### 2. 配置要求

#### 环境变量 (.env)
```bash
OPENAI_API_KEY="your-real-openai-api-key"
```

#### 配置文件 (config.toml)
确保以下配置正确：
- Qdrant URL: `http://localhost:6333`
- OpenAI API 配置
- 嵌入模型配置

### 3. 外部服务
- **Qdrant 向量数据库**: 需要在 6333 端口运行
- **OpenAI API**: 需要有效的 API 密钥

## 运行评估

### 添加记忆
```bash
python run_cortex_mem_evaluation.py --method add
```

### 搜索记忆并回答问题
```bash
python run_cortex_mem_evaluation.py --method search --top_k 10
```

### 运行评估指标
```bash
python evals.py --input_file results/cortex_mem_results.json --output_file results/cortex_mem_evaluated.json
```

### 生成评分报告
```bash
python generate_scores.py
```

## 评估流程

1. **准备阶段**: 验证系统配置和数据集
2. **添加阶段**: 将对话记忆添加到 Cortex Mem
3. **搜索阶段**: 基于问题检索相关记忆并生成答案
4. **评估阶段**: 计算 BLEU、F1、LLM 评分
5. **报告阶段**: 生成详细的评估报告

## 数据集信息

- **对话数量**: 10个不同场景
- **问答总数**: 38个精心设计的问题
- **参与者**: 20个不同的角色
- **覆盖领域**: 工作、学习、生活、兴趣等

## 评估指标

- **BLEU Score**: 答案相似度评估 (0-1)
- **F1 Score**: 精确率和召回率的调和平均 (0-1)
- **LLM Score**: GPT-4o-mini 智能评分 (0-1)
- **性能指标**: 搜索延迟、响应时间、Token 消耗

## 故障排除

### 常见问题

1. **ModuleNotFoundError: No module named 'langgraph'**
   - 已解决：使用专用评估脚本 `run_cortex_mem_evaluation.py`

2. **OpenAI API 错误**
   - 检查 `.env` 文件中的 API 密钥
   - 验证 `config.toml` 中的配置

3. **Qdrant 连接失败**
   - 启动 Qdrant: `docker run -p 6333:6333 qdrant/qdrant`
   - 检查端口: `netstat -an | findstr 6333`

4. **CLI 工具未找到**
   - 确保 cortex-mem-cli 构建成功
   - 检查路径配置

### 调试命令

```bash
# 检查配置
python -c "from src.cortex_mem.config_utils import validate_config; print(validate_config('config.toml'))"

# 检查数据集
python -c "import json; data = json.load(open('dataset/locomo10.json')); print(f'{len(data)} 个对话，{sum(len(item[\"qa\"]) for item in data)} 个问答')"

# 检查 CLI 工具
cd D:\Workspace\toys\cortex-mem\cortex-mem-cli
cargo run --bin cortex-mem-cli -- --help
```

## 输出文件

- `results/cortex_mem_results.json` - 原始评估结果
- `results/cortex_mem_evaluated.json` - 计算指标后的结果
- 评估报告和控制台输出

## 技术支持

- 查看 `问题解决报告.md` 了解详细的问题诊断和解决方案
- 查看 `测试状态报告.md` 了解系统状态和配置要求

---

**注意**: 所有命令都应该在项目根目录 `D:\Workspace\toys\cortex-mem\examples\lomoco-evaluation` 下执行。