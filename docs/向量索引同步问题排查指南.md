# ğŸ”§ Cortex-Memory å‘é‡ç´¢å¼•åŒæ­¥é—®é¢˜æ’æŸ¥æŒ‡å—

## é—®é¢˜ç°è±¡

ä½¿ç”¨ cortex-mem-insights æŸ¥è¯¢è®°å¿†æ—¶è¿”å›ç©ºç»“æœï¼Œä½†æ•°æ®æ–‡ä»¶ï¼ˆ.abstract.mdï¼‰å·²å­˜åœ¨ã€‚

## åŸå› åˆ†æ

### é—®é¢˜æ ¹æº

cortex-mem-tars é€€å‡ºæ—¶ç”Ÿæˆçš„å±‚çº§æ–‡ä»¶ï¼ˆ.abstract.mdã€.overview.mdï¼‰**æ²¡æœ‰è¢«è‡ªåŠ¨ç´¢å¼•åˆ° Qdrant å‘é‡æ•°æ®åº“**ã€‚

### æ•°æ®æµç¨‹

```
cortex-mem-tars é€€å‡º
  â†“
ç”Ÿæˆ .abstract.md å’Œ .overview.md (âœ… å·²å®Œæˆ)
  â†“
ã€ç¼ºå¤±ç¯èŠ‚ã€‘å‘é‡ç´¢å¼•æœªè§¦å‘ (âŒ é—®é¢˜æ‰€åœ¨)
  â†“
cortex-mem-service æŸ¥è¯¢ Qdrant
  â†“
è¿”å›ç©ºç»“æœ (å› ä¸ºå‘é‡æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®)
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ‰‹åŠ¨è§¦å‘ç´¢å¼• (ä¸´æ—¶æ–¹æ¡ˆ)

ä½¿ç”¨ cortex-mem-service çš„ API æ‰‹åŠ¨è§¦å‘ç´¢å¼•ï¼š

```bash
# 1. ç¡®è®¤å·²åˆ‡æ¢åˆ°æ­£ç¡®çš„ç§Ÿæˆ·
curl -X POST http://localhost:3000/api/tenants/switch \
  -H "Content-Type: application/json" \
  -d '{"tenant_id": "bf323233-1f53-4337-a8e7-2ebe9b0080d0"}'

# 2. è§¦å‘å…¨é‡ç´¢å¼•
curl -X POST http://localhost:3000/api/automation/index-all
```

### æ–¹æ¡ˆ 2: å¯åŠ¨æ—¶è‡ªåŠ¨ç´¢å¼• (æ¨è)

ä¿®æ”¹ cortex-mem-service çš„å¯åŠ¨é€»è¾‘ï¼Œåœ¨åˆ‡æ¢ç§Ÿæˆ·åè‡ªåŠ¨ç´¢å¼•æ‰€æœ‰æœªç´¢å¼•çš„æ–‡ä»¶ã€‚

#### 2.1 ä¿®æ”¹ AppState::switch_tenant()

```rust
// cortex-mem-service/src/state.rs
pub async fn switch_tenant(&self, tenant_id: &str) -> anyhow::Result<()> {
    // ... ç°æœ‰ä»£ç  ...
    
    // ğŸ†• åˆ‡æ¢ç§Ÿæˆ·åï¼Œè‡ªåŠ¨ç´¢å¼•æœªç´¢å¼•çš„æ–‡ä»¶
    if let (Some(qdrant_store), Some(ec)) = (&self.vector_store, &self.embedding_client) {
        tracing::info!("ğŸ” å¼€å§‹è‡ªåŠ¨ç´¢å¼•ç§Ÿæˆ· {} çš„æ–‡ä»¶...", tenant_id);
        
        let indexer = cortex_mem_core::AutoIndexer::new(
            tenant_filesystem.clone(),
            ec.clone(),
            qdrant_store.clone(),
            cortex_mem_core::IndexerConfig {
                auto_index: true,
                batch_size: 10,
                async_index: false, // åŒæ­¥ç´¢å¼•ï¼Œç¡®ä¿å®Œæˆ
            },
        );
        
        match indexer.index_all().await {
            Ok(stats) => {
                tracing::info!(
                    "âœ… è‡ªåŠ¨ç´¢å¼•å®Œæˆ: {} ä¸ªæ–‡ä»¶å·²ç´¢å¼•, {} ä¸ªæ–‡ä»¶è·³è¿‡",
                    stats.indexed_files,
                    stats.skipped_files
                );
            }
            Err(e) => {
                tracing::warn!("âš ï¸ è‡ªåŠ¨ç´¢å¼•å¤±è´¥: {}", e);
            }
        }
    }
    
    Ok(())
}
```

### æ–¹æ¡ˆ 3: cortex-mem-tars é€€å‡ºæ—¶è§¦å‘ç´¢å¼• (æœ€ä½³æ–¹æ¡ˆ)

ä¿®æ”¹ cortex-mem-tars çš„é€€å‡ºé€»è¾‘ï¼Œåœ¨ç”Ÿæˆå±‚çº§æ–‡ä»¶åç«‹å³ç´¢å¼•ã€‚

#### 3.1 ä¿®æ”¹ App::on_exit()

```rust
// examples/cortex-mem-tars/src/app.rs
pub async fn on_exit(&mut self) -> Result<()> {
    // ... ç°æœ‰çš„ä¼šè¯å…³é—­å’Œå±‚çº§ç”Ÿæˆé€»è¾‘ ...
    
    // ğŸ†• é€€å‡ºæ—¶ç´¢å¼•æ‰€æœ‰æ–°ç”Ÿæˆçš„å±‚çº§æ–‡ä»¶
    if let Some(tenant_ops) = &self.tenant_operations {
        log::info!("ğŸ“Š å¼€å§‹ç´¢å¼•æ–°ç”Ÿæˆçš„å±‚çº§æ–‡ä»¶...");
        
        // è·å– auto_indexer
        // æ³¨æ„: éœ€è¦åœ¨ MemoryOperations ä¸­æ·»åŠ  auto_indexer() æ–¹æ³•
        if let Some(indexer) = tenant_ops.auto_indexer() {
            match indexer.index_all().await {
                Ok(stats) => {
                    log::info!(
                        "âœ… ç´¢å¼•å®Œæˆ: {} ä¸ªæ–‡ä»¶å·²ç´¢å¼•, {} ä¸ªæ–‡ä»¶è·³è¿‡",
                        stats.indexed_files,
                        stats.skipped_files
                    );
                }
                Err(e) => {
                    log::warn!("âš ï¸ ç´¢å¼•å¤±è´¥: {}", e);
                }
            }
        }
    }
    
    Ok(())
}
```

#### 3.2 ä¿®æ”¹ MemoryOperations æ·»åŠ  auto_indexer è®¿é—®

```rust
// cortex-mem-tools/src/operations.rs
pub struct MemoryOperations {
    // ... ç°æœ‰å­—æ®µ ...
    pub(crate) auto_indexer: Option<Arc<AutoIndexer>>,  // ğŸ†• æ·»åŠ å­—æ®µ
}

impl MemoryOperations {
    /// ğŸ†• è·å– auto_indexerï¼ˆç”¨äºæ‰‹åŠ¨è§¦å‘ç´¢å¼•ï¼‰
    pub fn auto_indexer(&self) -> Option<&Arc<AutoIndexer>> {
        self.auto_indexer.as_ref()
    }
    
    pub async fn new(...) -> Result<Self> {
        // ... ç°æœ‰ä»£ç  ...
        
        // ä¿å­˜ auto_indexer ä»¥ä¾¿å¤–éƒ¨è®¿é—®
        Ok(Self {
            // ... ç°æœ‰å­—æ®µ ...
            auto_indexer: Some(auto_indexer),  // ğŸ†• ä¿å­˜å¼•ç”¨
        })
    }
}
```

## éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥ Qdrant collection

```bash
curl -s http://localhost:6334/collections/cortex-mem-tars-v2_bf323233-1f53-4337-a8e7-2ebe9b0080d0 | jq '.result.points_count'
```

**é¢„æœŸç»“æœ**: åº”è¯¥æœ‰ç‚¹æ•° > 0ï¼ˆå¦‚æœæ•°æ®å·²ç´¢å¼•ï¼‰

### 2. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨

```bash
find ~/Library/Application\ Support/com.cortex-mem.tars/cortex/tenants/bf323233-1f53-4337-a8e7-2ebe9b0080d0/user/tars_user -name ".abstract.md"
```

**é¢„æœŸç»“æœ**: åº”è¯¥æ‰¾åˆ°å¤šä¸ª .abstract.md æ–‡ä»¶

### 3. æ‰‹åŠ¨ç´¢å¼•å¹¶éªŒè¯

```bash
# è§¦å‘ç´¢å¼•
curl -X POST http://localhost:3000/api/automation/index-all

# ç­‰å¾…å‡ ç§’åæŸ¥è¯¢
curl -X POST http://localhost:3000/api/search \
  -H "Content-Type: application/json" \
  -d '{"query": "æ¨é›ª", "limit": 5}'
```

**é¢„æœŸç»“æœ**: åº”è¯¥è¿”å›ç›¸å…³ç»“æœ

## å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
- å±‚çº§æ–‡ä»¶ç”Ÿæˆæœºåˆ¶ (.abstract.md, .overview.md)
- é€€å‡ºæ—¶è‡ªåŠ¨ç”Ÿæˆç¼ºå¤±æ–‡ä»¶
- ç§Ÿæˆ·åˆ‡æ¢åŠŸèƒ½
- å‘é‡æœç´¢å¼•æ“é›†æˆ

### âŒ ç¼ºå¤±
- **è‡ªåŠ¨ç´¢å¼•æœªè§¦å‘**: ç”Ÿæˆå±‚çº§æ–‡ä»¶åæœªè‡ªåŠ¨ç´¢å¼•
- **é€€å‡ºæ—¶ç´¢å¼•**: cortex-mem-tars é€€å‡ºæ—¶æœªè§¦å‘ç´¢å¼•

## æ¨èè¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**: ä½¿ç”¨æ–¹æ¡ˆ 1 æ‰‹åŠ¨è§¦å‘ç´¢å¼•ï¼ŒéªŒè¯åŠŸèƒ½
2. **çŸ­æœŸä¿®å¤**: å®ç°æ–¹æ¡ˆ 2ï¼Œåœ¨ cortex-mem-service åˆ‡æ¢ç§Ÿæˆ·æ—¶è‡ªåŠ¨ç´¢å¼•
3. **é•¿æœŸæ–¹æ¡ˆ**: å®ç°æ–¹æ¡ˆ 3ï¼Œåœ¨ cortex-mem-tars é€€å‡ºæ—¶è‡ªåŠ¨ç´¢å¼•

## æ—¥å¿—å…³é”®ç‚¹

ä»ä½ æä¾›çš„æ—¥å¿—çœ‹ï¼š

```log
2026-02-25T12:15:53.711044Z  WARN No L0 results found at threshold 0.4
2026-02-25T12:15:53.712989Z  WARN No results even with relaxed threshold
```

è¿™è¯´æ˜ï¼š
- âœ… ç§Ÿæˆ·åˆ‡æ¢æˆåŠŸ
- âœ… å‘é‡æœç´¢å¼•æ“æ­£å¸¸å·¥ä½œ
- âŒ Qdrant collection ä¸­**æ²¡æœ‰æ•°æ®**ï¼ˆpoints_count = 0ï¼‰

æ ¸å¿ƒé—®é¢˜ç¡®è®¤ï¼š**å‘é‡ç´¢å¼•æœªåŒæ­¥**ã€‚
