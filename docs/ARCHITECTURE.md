# Cortex Memory V2 架构设计文档

**版本**: V2.0.0  
**更新时间**: 2026-02-04  
**作者**: Cortex Memory Development Team

---

## 📋 目录

1. [架构概览](#1-架构概览)
2. [核心设计理念](#2-核心设计理念)
3. [系统架构](#3-系统架构)
4. [核心模块](#4-核心模块)
5. [数据流](#5-数据流)
6. [技术选型](#6-技术选型)
7. [部署架构](#7-部署架构)

---

## 1. 架构概览

### 1.1 系统定位

Cortex Memory V2是一个**基于文件系统的AI Agent记忆管理系统**，采用虚拟URI协议和三层抽象架构，为AI Agent提供长期记忆存储、检索和管理能力。

### 1.2 核心目标

- ✅ **长期记忆持久化**: 支持AI Agent跨会话记忆
- ✅ **智能检索**: 基于意图和语义的高效检索
- ✅ **灵活扩展**: 模块化设计，易于集成
- ✅ **零依赖存储**: 纯Markdown文件，易迁移
- ✅ **工具链完善**: CLI、MCP、HTTP多种访问方式

### 1.3 V1 vs V2

| 特性 | V1 | V2 |
|------|----|----|
| 存储方式 | Qdrant向量数据库 | Markdown文件系统 + 可选向量 |
| URI协议 | 无 | cortex:// 虚拟协议 |
| 抽象层 | 无 | L0/L1/L2三层架构 |
| 会话管理 | 简单存储 | 完整生命周期 + Timeline |
| 记忆提取 | 无 | LLM驱动的自动提取 |
| 依赖 | Qdrant必须 | 零外部依赖 |
| LLM集成 | 无框架 | rig-core 0.23 |
| MCP支持 | 无 | rmcp 0.14 |

---

## 2. 核心设计理念

### 2.1 虚拟文件系统 (cortex://)

**设计动机**: 
- 统一内存访问接口
- 支持分层组织
- 易于理解和调试

**URI格式**:
```
cortex://threads/{thread_id}/timeline/{YYYY-MM}/{DD}/{HH_MM_SS}_{message_id}.md
cortex://users/{user_id}/memories/{category}/{memory_id}.md
cortex://agents/{agent_id}/memories/{category}/{memory_id}.md
```

**优势**:
- 📂 清晰的层次结构
- 🔍 易于浏览和搜索
- 🛠️ 支持手动编辑和版本控制
- 🔗 跨平台兼容

### 2.2 三层抽象架构 (L0/L1/L2)

**设计动机**:
- 优化LLM上下文使用
- 支持渐进式信息加载
- 提高检索效率

**三层定义**:

#### L0 - 抽象层 (~100 tokens)
- **目的**: 快速浏览和筛选
- **内容**: 标题、摘要、关键词
- **使用场景**: 列表展示、初步筛选

#### L1 - 概览层 (~2k tokens)
- **目的**: 详细理解上下文
- **内容**: 完整摘要、主要事实、决策点
- **使用场景**: 检索结果、上下文构建

#### L2 - 完整内容
- **目的**: 深度分析和编辑
- **内容**: 原始数据、所有细节
- **使用场景**: 详细查看、数据分析

**检索策略**:
```
用户查询 → L0筛选候选 → L1评估相关性 → L2返回结果
```

### 2.3 模块化设计

**设计原则**:
- 🧩 **松耦合**: 模块间通过明确接口通信
- 🔄 **可替换**: 底层实现可更换（如存储引擎）
- 📦 **可组合**: 支持按需组合功能
- 🧪 **可测试**: 每个模块独立测试

**模块层次**:
```
应用层 (CLI, MCP, HTTP, Web)
    ↓
核心库 (cortex-mem-core)
    ├── 文件系统 (filesystem)
    ├── 会话管理 (session)
    ├── 记忆提取 (extraction)
    ├── 检索引擎 (search)
    └── LLM集成 (llm)
    ↓
存储层 (Markdown files)
```

---

## 3. 系统架构

### 3.1 总体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        应用层                                │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │   CLI    │  │   MCP    │  │  HTTP    │  │  Web UI  │   │
│  │  工具    │  │  服务器  │  │  服务    │  │ (开发中) │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
└───────┼─────────────┼─────────────┼─────────────┼──────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                      │
┌─────────────────────┴─────────────────────────────────────┐
│                    核心库层 (cortex-mem-core)              │
│                                                            │
│  ┌──────────────────────────────────────────────────┐    │
│  │         虚拟文件系统 (CortexFilesystem)           │    │
│  │                 cortex:// 协议                     │    │
│  └─────────────────────┬────────────────────────────┘    │
│                        │                                  │
│  ┌─────────────────────┴────────────────────────────┐    │
│  │           L0/L1/L2 三层抽象引擎                   │    │
│  │    - 自动摘要生成                                  │    │
│  │    - 渐进式加载                                    │    │
│  │    - 层级索引                                      │    │
│  └─────────────────────┬────────────────────────────┘    │
│                        │                                  │
│  ┌─────────────────────┴────────────────────────────┐    │
│  │              功能模块层                           │    │
│  │                                                   │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐   │    │
│  │  │  会话管理  │  │  记忆提取  │  │  检索引擎  │   │    │
│  │  │           │  │           │  │           │   │    │
│  │  │ Session   │  │Extraction │  │  Search   │   │    │
│  │  │ Manager   │  │  Engine   │  │  Engine   │   │    │
│  │  └───────────┘  └───────────┘  └───────────┘   │    │
│  │                                                   │    │
│  │  ┌───────────────────────────────────────────┐  │    │
│  │  │          LLM 集成层 (rig-core)             │  │    │
│  │  │  - OpenAI兼容API                           │  │    │
│  │  │  - 结构化提示                               │  │    │
│  │  │  - 流式响应                                 │  │    │
│  │  └───────────────────────────────────────────┘  │    │
│  └───────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────┘
                      │
┌─────────────────────┴─────────────────────────────────────┐
│                    存储层                                  │
│                                                            │
│  ┌──────────────────────────────────────────────────┐    │
│  │         Markdown 文件系统                          │    │
│  │                                                   │    │
│  │  cortex-data/                                    │    │
│  │  ├── threads/          # 会话数据                 │    │
│  │  ├── users/            # 用户记忆                 │    │
│  │  ├── agents/           # Agent记忆                │    │
│  │  └── index/            # 索引数据                 │    │
│  └──────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────┘
```

### 3.2 模块依赖关系

```
┌─────────────────┐
│  Applications   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  cortex-mem-    │
│  core           │◄─────┐
└────────┬────────┘      │
         │               │
    ┌────┴────┐          │
    ▼         ▼          │
┌────────┐ ┌──────┐     │
│ rig-    │ │rmcp  │     │
│ core    │ │      │     │
└─────────┘ └──────┘     │
                         │
┌─────────────────┐      │
│  cortex-mem-    │──────┘
│  config         │
└─────────────────┘
```

---

## 4. 核心模块

### 4.1 文件系统模块 (filesystem)

**职责**:
- cortex:// URI解析和路由
- 文件读写操作
- 目录遍历和列表
- 路径规范化

**核心接口**:
```rust
pub trait FilesystemOperations {
    async fn read(&self, uri: &str) -> Result<String>;
    async fn write(&self, uri: &str, content: &str) -> Result<()>;
    async fn list(&self, uri: &str) -> Result<Vec<FileEntry>>;
    async fn delete(&self, uri: &str) -> Result<()>;
    async fn exists(&self, uri: &str) -> Result<bool>;
}
```

**实现细节**: 见 [modules/FILESYSTEM.md](modules/FILESYSTEM.md)

### 4.2 会话管理模块 (session)

**职责**:
- 会话生命周期管理
- 消息存储和检索
- Timeline时间轴组织
- 参与者管理

**核心组件**:
- `SessionManager`: 会话管理器
- `MessageStorage`: 消息存储
- `ParticipantManager`: 参与者管理

**实现细节**: 见 [modules/SESSION.md](modules/SESSION.md)

### 4.3 记忆提取模块 (extraction)

**职责**:
- 从对话中提取结构化记忆
- LLM驱动的智能分析
- 事实、决策、实体识别

**提取类型**:
- **Facts**: 陈述性知识
- **Decisions**: 决策点和推理
- **Entities**: 人物、概念、事件

**实现细节**: 见 [modules/EXTRACTION.md](modules/EXTRACTION.md)

### 4.4 检索引擎模块 (search)

**职责**:
- 文件系统全文搜索
- 可选的向量语义搜索
- 意图分析和查询优化

**检索策略**:
1. **文件系统搜索**: 快速、准确
2. **向量搜索**: 语义理解（可选）
3. **混合搜索**: 结合两者优势

**实现细节**: 见 [modules/SEARCH.md](modules/SEARCH.md)

### 4.5 LLM集成模块 (llm)

**职责**:
- LLM客户端管理
- 提示工程
- 结构化输出解析

**基于**: rig-core 0.23

**实现细节**: 见 [modules/LLM.md](modules/LLM.md)

---

## 5. 数据流

### 5.1 消息添加流程

```
用户输入
    ↓
CLI/MCP/HTTP API
    ↓
SessionManager.add_message()
    ↓
MessageStorage.save_message()
    ↓
生成Timeline路径
cortex://threads/{id}/timeline/YYYY-MM/DD/HH_MM_SS_{msg_id}.md
    ↓
Filesystem.write()
    ↓
Markdown文件写入磁盘
```

### 5.2 搜索流程

```
用户查询
    ↓
SearchEngine.search()
    ↓
意图分析 (关键词提取)
    ↓
┌─────────────┬─────────────┐
│ 文件系统搜索  │  向量搜索    │
└──────┬──────┴──────┬──────┘
       │             │
       └──────┬──────┘
              ↓
      结果合并和排序
              ↓
      L0/L1/L2加载
              ↓
      返回给用户
```

### 5.3 记忆提取流程

```
会话关闭
    ↓
AutoExtractor.on_session_close()
    ↓
加载所有消息 (MessageStorage)
    ↓
构建对话上下文
    ↓
┌────────────┬────────────┬────────────┐
│ 提取Facts  │ 提取Decisions│ 提取Entities│
└──────┬─────┴──────┬─────┴──────┬─────┘
       │            │            │
       └────────────┴────────────┘
              ↓
      LLM分析 (rig-core)
              ↓
      结构化结果
              ↓
┌─────────────┬─────────────┐
│ 用户记忆     │  Agent记忆   │
│ users/{id}/ │ agents/{id}/ │
└─────────────┴─────────────┘
              ↓
      Filesystem.write()
```

---

## 6. 技术选型

### 6.1 编程语言

**Rust 1.92+**

**选择理由**:
- ✅ 性能优异（接近C++）
- ✅ 内存安全（无GC、无段错误）
- ✅ 并发友好（async/await）
- ✅ 生态成熟（Cargo、crates.io）
- ✅ 跨平台支持

### 6.2 核心依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| tokio | 1.48 | 异步运行时 |
| serde | 1.0 | 序列化/反序列化 |
| axum | 0.7 | Web框架 |
| rig-core | 0.23 | LLM集成 |
| rmcp | 0.14 | MCP协议 |
| clap | 4.5 | CLI参数解析 |
| tantivy | 0.22 | 全文搜索引擎 |

**完整依赖**: 见 [Cargo.toml](../Cargo.toml)

### 6.3 可选功能

| Feature | 说明 | 依赖 |
|---------|------|------|
| vector-search | 向量搜索 | qdrant-client |
| web-ui | Web界面 | SvelteKit |

---

## 7. 部署架构

### 7.1 单机部署

```
┌──────────────────────────┐
│   Linux/macOS/Windows    │
│                          │
│  ┌────────────────────┐  │
│  │  cortex-mem-cli    │  │
│  └────────────────────┘  │
│                          │
│  ┌────────────────────┐  │
│  │ cortex-mem-service │  │
│  │   (HTTP:8080)      │  │
│  └────────────────────┘  │
│                          │
│  ┌────────────────────┐  │
│  │  cortex-data/      │  │
│  │  (Markdown files)  │  │
│  └────────────────────┘  │
└──────────────────────────┘
```

### 7.2 Claude Desktop集成

```
┌─────────────────┐
│ Claude Desktop  │
│                 │
│  ┌───────────┐  │
│  │   MCP     │  │
│  │  Client   │  │
│  └─────┬─────┘  │
└────────┼────────┘
         │ stdio
         ↓
┌──────────────────────┐
│  cortex-mem-mcp      │
│  (MCP Server)        │
└──────────┬───────────┘
           │
           ↓
┌──────────────────────┐
│  cortex-mem-core     │
└──────────┬───────────┘
           │
           ↓
┌──────────────────────┐
│  cortex-data/        │
└──────────────────────┘
```

### 7.3 分布式部署（未来）

```
┌─────────────┐
│  Web Client │
└──────┬──────┘
       │ HTTP
       ↓
┌─────────────────┐
│  Load Balancer  │
└────────┬────────┘
         │
    ┌────┴────┬────────┐
    │         │        │
    ↓         ↓        ↓
┌────────┐┌────────┐┌────────┐
│Service1││Service2││Service3│
└────┬───┘└────┬───┘└────┬───┘
     │         │         │
     └─────────┴─────────┘
              │
              ↓
     ┌────────────────┐
     │  Shared Storage│
     │  (NFS/S3)      │
     └────────────────┘
```

---

## 8. 性能考量

### 8.1 性能目标

| 操作 | 目标延迟 | 备注 |
|------|---------|------|
| 文件读取 | < 10ms | 本地SSD |
| 消息添加 | < 50ms | 包含写入 |
| 全文搜索 | < 100ms | 1000条消息内 |
| 向量搜索 | < 200ms | 需Qdrant |
| 记忆提取 | 2-5s | LLM调用 |

### 8.2 优化策略

1. **异步I/O**: 使用tokio异步运行时
2. **批量操作**: 支持批量读写
3. **缓存机制**: 热点数据内存缓存（未来）
4. **索引优化**: tantivy全文索引
5. **并发控制**: RwLock细粒度锁

---

## 9. 安全性

### 9.1 数据安全

- ✅ 本地存储，数据不出本地
- ✅ 支持文件系统权限控制
- ✅ 可集成加密文件系统

### 9.2 API安全

- ⚠️ HTTP服务默认无鉴权（内网使用）
- ✅ 建议使用反向代理添加认证
- ✅ 支持HTTPS（通过代理）

### 9.3 LLM隐私

- ✅ 支持自部署LLM（数据不出本地）
- ⚠️ 使用第三方API需注意隐私协议

---

## 10. 扩展性

### 10.1 横向扩展

- 多服务实例 + 负载均衡
- 共享文件系统（NFS/S3）
- 分布式锁（Redis）

### 10.2 垂直扩展

- 更大内存 → 更多缓存
- 更快磁盘 → 更低延迟
- 更多CPU → 更多并发

---

## 11. 未来规划

### V2.1
- [ ] 完善Web界面
- [ ] 向量搜索优化
- [ ] WebSocket实时推送

### V2.2
- [ ] 知识图谱集成
- [ ] 高级分析功能
- [ ] 插件系统

### V3.0
- [ ] 分布式架构
- [ ] 多租户支持
- [ ] 企业版功能

---

## 12. 参考文档

- [文件系统模块](modules/FILESYSTEM.md)
- [会话管理模块](modules/SESSION.md)
- [记忆提取模块](modules/EXTRACTION.md)
- [检索引擎模块](modules/SEARCH.md)
- [LLM集成模块](modules/LLM.md)

---

**文档版本**: 1.0  
**最后更新**: 2026-02-04  
**维护者**: Cortex-Mem Team
