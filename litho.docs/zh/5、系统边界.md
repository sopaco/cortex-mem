# 系统边界接口文档

本文档描述了系统的外部调用接口，包括CLI命令、API端点、配置参数和其他边界机制。

## 命令行接口（CLI）

### cortex-mem-cli

**描述**: 用于与Cortex-Mem系统交互的命令行界面，支持搜索、添加、列出、获取、删除、会话管理、层级管理和租户管理等操作。

**源文件**: `cortex-mem-cli/src/main.rs`

**全局选项**:

| 选项 | 简写 | 默认值 | 描述 |
|--------|-------|---------|-------------|
| `--config` | `-c` | `config.toml` | 配置文件路径 |
| `--tenant` | | `default` | 租户标识符（使用 `tenant list` 查看可用租户） |
| `--verbose` | `-v` | `false` | 启用详细/调试日志 |

**可用命令**:

| 命令 | 描述 |
|---------|-------------|
| `session` | 会话管理（创建、列出） |
| `add` | 向会话添加消息 |
| `search` | 使用语义向量搜索记忆 |
| `list` | 列出目录中的记忆 |
| `get` | 通过URI获取特定记忆 |
| `delete` | 通过URI删除记忆 |
| `layers` | 层级管理（L0/L1文件） |
| `stats` | 显示系统统计信息 |
| `tenant` | 租户管理（列出可用租户） |

**使用示例**:

```bash
# 列出可用租户
cortex-mem -c config.toml tenant list

# 创建会话
cortex-mem -c config.toml session create my-session --title "我的会话"

# 添加消息
cortex-mem -c config.toml add --thread my-session "你好，这是一条测试消息"

# 搜索记忆
cortex-mem -c config.toml search "用户偏好" --scope user --limit 5

# 列出记忆
cortex-mem -c config.toml list --uri cortex://user

# 获取特定记忆
cortex-mem -c config.toml get cortex://session/my-session/timeline/2024/01/15/14_30_00_abc123.md

# 显示统计信息
cortex-mem -c config.toml stats

# 生成缺失的L0/L1层级文件
cortex-mem -c config.toml layers ensure-all
```

## API接口

### GET /health

**描述**: 返回系统健康状态，包括服务版本、LLM可用性和时间戳。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: {"status": "string", "service": "string", "version": "string", "llm_available": "boolean", "timestamp": "string"}

### GET /filesystem/list

**描述**: 列出指定URI下的目录内容，过滤隐藏文件，但.abstract.md和.overview.md除外。

**源文件**: `cortex-mem-service/src/handlers/filesystem.rs`

**响应格式**: 文件/目录名称数组

### GET /filesystem/read/*path

**描述**: 读取指定路径的文件内容，如果存在则剥离'cortex://'前缀。

**源文件**: `cortex-mem-service/src/handlers/filesystem.rs`

**响应格式**: 字符串（文件内容）

### POST /filesystem/write

**描述**: 将内容写入指定路径的文件；如需要会自动创建父目录。

**源文件**: `cortex-mem-service/src/handlers/filesystem.rs`

**请求格式**: {"path": "string", "content": "string"}

**响应格式**: {"success": "boolean", "message": "string"}

### GET /filesystem/stats

**描述**: 返回目录的递归统计信息：文件数和总大小。

**源文件**: `cortex-mem-service/src/handlers/filesystem.rs`

**响应格式**: {"file_count": "integer", "total_size": "integer"}

### GET /sessions

**描述**: 列出所有活动会话及其元数据。

**源文件**: `cortex-mem-service/src/handlers/sessions.rs`

**响应格式**: 会话对象数组

### POST /sessions

**描述**: 创建新会话，可选thread_id和title。

**源文件**: `cortex-mem-service/src/handlers/sessions.rs`

**请求格式**: {"thread_id": "string", "title": "string"}

**响应格式**: {"session_id": "string", "thread_id": "string", "created_at": "string"}

### POST /sessions/:thread_id/messages

**描述**: 向会话线程添加消息，包含role和content。

**源文件**: `cortex-mem-service/src/handlers/sessions.rs`

**请求格式**: {"role": "string", "content": "string"}

**响应格式**: {"message_id": "string", "timestamp": "string"}

### POST /sessions/:thread_id/close

**描述**: 关闭会话线程，标记为非活动。

**源文件**: `cortex-mem-service/src/handlers/sessions.rs`

**请求格式**: {}

**响应格式**: {"status": "closed", "thread_id": "string"}

### POST /search

**描述**: 使用分层L0/L1/L2检索执行语义搜索；支持query、thread context、limit和min_score。

**源文件**: `cortex-mem-service/src/handlers/search.rs`

**请求格式**: {"query": "string", "thread": "string", "limit": "integer", "min_score": "float"}

**响应格式**: {"results": [{"id": "string", "content": "string", "score": "float", "snippet": "string"}]}

### POST /automation/extract/:thread_id

**描述**: 触发从会话线程的LLM记忆提取；支持auto_save标志。

**源文件**: `cortex-mem-service/src/handlers/automation.rs`

**请求格式**: {"auto_save": "boolean"}

**响应格式**: {"extracted_facts": "integer", "extracted_entities": "integer", "extracted_decisions": "integer", "saved": "boolean"}

### POST /automation/index/:thread_id

**描述**: 已弃用：索引特定线程（请使用提取）。

**源文件**: `cortex-mem-service/src/handlers/automation.rs`

**请求格式**: {}

**响应格式**: {"status": "deprecated", "message": "Use /automation/extract instead"}

### POST /automation/index-all

**描述**: 已弃用：索引所有线程（请使用提取）。

**源文件**: `cortex-mem-service/src/handlers/automation.rs`

**请求格式**: {}

**响应格式**: {"status": "deprecated", "message": "Use /automation/extract instead"}

### GET /tenants

**描述**: 列出所有可用租户。

**源文件**: `cortex-mem-service/src/handlers/tenants.rs`

**响应格式**: 租户ID数组

### POST /tenants/switch

**描述**: 切换活动租户上下文。

**源文件**: `cortex-mem-service/src/handlers/tenants.rs`

**请求格式**: {"tenant_id": "string"}

**响应格式**: {"current_tenant": "string", "success": "boolean"}

### GET /api/v2/health

**描述**: v2 API命名空间下的健康端点（与/health相同）。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: {"status": "string", "service": "string", "version": "string", "llm_available": "boolean", "timestamp": "string"}

### GET /api/v2/filesystem/list

**描述**: v2 API命名空间下列出目录内容。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: 文件/目录名称数组

### GET /api/v2/filesystem/read/*path

**描述**: v2 API命名空间下读取文件内容。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: 字符串（文件内容）

### POST /api/v2/filesystem/write

**描述**: v2 API命名空间下写文件。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {"path": "string", "content": "string"}

**响应格式**: {"success": "boolean", "message": "string"}

### GET /api/v2/filesystem/stats

**描述**: v2 API命名空间下获取目录统计。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: {"file_count": "integer", "total_size": "integer"}

### GET /api/v2/sessions

**描述**: v2 API命名空间下列出会话。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: 会话对象数组

### POST /api/v2/sessions

**描述**: v2 API命名空间下创建会话。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {"thread_id": "string", "title": "string"}

**响应格式**: {"session_id": "string", "thread_id": "string", "created_at": "string"}

### POST /api/v2/sessions/:thread_id/messages

**描述**: v2 API命名空间下向会话添加消息。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {"role": "string", "content": "string"}

**响应格式**: {"message_id": "string", "timestamp": "string"}

### POST /api/v2/sessions/:thread_id/close

**描述**: v2 API命名空间下关闭会话。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {}

**响应格式**: {"status": "closed", "thread_id": "string"}

### POST /api/v2/search

**描述**: v2 API命名空间下的语义搜索。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {"query": "string", "thread": "string", "limit": "integer", "min_score": "float"}

**响应格式**: {"results": [{"id": "string", "content": "string", "score": "float", "snippet": "string"}]}

### POST /api/v2/automation/extract/:thread_id

**描述**: v2 API命名空间下触发记忆提取。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {"auto_save": "boolean"}

**响应格式**: {"extracted_facts": "integer", "extracted_entities": "integer", "extracted_decisions": "integer", "saved": "boolean"}

### POST /api/v2/automation/index/:thread_id

**描述**: 已弃用：v2 API命名空间下索引线程。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {}

**响应格式**: {"status": "deprecated", "message": "Use /automation/extract instead"}

### POST /api/v2/automation/index-all

**描述**: 已弃用：v2 API命名空间下索引所有线程。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {}

**响应格式**: {"status": "deprecated", "message": "Use /automation/extract instead"}

### GET /api/v2/tenants

**描述**: v2 API命名空间下列出租户。

**源文件**: `cortex-mem-service/src/main.rs`

**响应格式**: 租户ID数组

### POST /api/v2/tenants/switch

**描述**: v2 API命名空间下切换租户。

**源文件**: `cortex-mem-service/src/main.rs`

**请求格式**: {"tenant_id": "string"}

**响应格式**: {"current_tenant": "string", "success": "boolean"}

## MCP工具

### store_memory

**描述**: 在会话线程中存储记忆消息。如果会话不存在则自动创建。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `content` (字符串): 必需 - 要存储的记忆内容
- `thread_id` (字符串): 可选 - 线程/会话ID（默认为"default"）
- `role` (字符串): 可选 - 角色（user/assistant/system，默认为"user"）

**响应格式**: {"success": "boolean", "uri": "string", "message_id": "string"}

### query_memory

**描述**: 使用语义向量搜索和L0/L1/L2分层检索搜索记忆。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `query` (字符串): 必需 - 自然语言查询
- `thread_id` (字符串): 可选 - 限定到特定线程
- `limit` (整数): 可选 - 最大结果数（默认: 10）
- `min_score` (浮点数): 可选 - 最小相似度分数（默认: 0.6）

**响应格式**: {"results": [{"id": "string", "content": "string", "score": "float", "uri": "string"}]}

### list_memories

**描述**: 列出线程中的记忆，支持分页。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `thread_id` (字符串): 可选 - 要列出的线程ID
- `limit` (整数): 可选 - 最大结果数（默认: 50）
- `offset` (整数): 可选 - 分页偏移量

**响应格式**: {"memories": [{"id": "string", "uri": "string", "timestamp": "string"}], "total": "integer"}

### get_memory

**描述**: 通过URI或ID检索特定记忆。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `uri` (字符串): 必需 - 记忆URI或ID

**响应格式**: {"id": "string", "content": "string", "uri": "string", "metadata": "object"}

### delete_memory

**描述**: 删除记忆及其关联的所有层向量（L0/L1/L2）。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `uri` (字符串): 必需 - 要删除的记忆URI

**响应格式**: {"success": "boolean", "message": "string"}

### get_abstract

**描述**: 获取记忆的L0抽象摘要。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `uri` (字符串): 必需 - 记忆URI

**响应格式**: {"uri": "string", "abstract_text": "string"}

### generate_layers

**描述**: 为记忆生成L0/L1层级文件。支持会话作用域或全量生成。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `thread_id` (字符串): 可选 - 会话作用域生成的线程ID（如果省略则为全部生成）

**响应格式**: {"success": "boolean", "message": "string", "total": "integer", "generated": "integer", "failed": "integer"}

### index_memories

**描述**: 将记忆索引到向量数据库。支持会话作用域或全量索引。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `thread_id` (字符串): 可选 - 会话作用域索引的线程ID（如果省略则索引全部）

**响应格式**: {"success": "boolean", "message": "string", "total_files": "integer", "indexed_files": "integer", "skipped_files": "integer", "error_files": "integer"}

### close_session

**描述**: 关闭会话并触发最终处理（L0/L1生成、记忆提取、索引）。

**源文件**: `cortex-mem-mcp/src/service.rs`

**参数**:
- `thread_id` (字符串): 必需 - 要关闭的线程/会话ID

**响应格式**: {"success": "boolean", "thread_id": "string", "message": "string"}

## 路由器路由

### /filesystem/list

**描述**: 列出租户数据根目录下的目录内容。

**源文件**: `cortex-mem-service/src/routes/filesystem.rs`

### /filesystem/read/*path

**描述**: 读取指定路径的文件；通配符捕获相对于数据根的完整路径。

**源文件**: `cortex-mem-service/src/routes/filesystem.rs`

**参数**:

- `path` (字符串): cortex数据目录内的相对文件路径

### /filesystem/write

**描述**: 将内容写入文件；父目录自动创建。

**源文件**: `cortex-mem-service/src/routes/filesystem.rs`

### /filesystem/stats

**描述**: 返回目录的递归统计信息。

**源文件**: `cortex-mem-service/src/routes/filesystem.rs`

### /sessions

**描述**: 管理会话生命周期：列出或创建会话。

**源文件**: `cortex-mem-service/src/routes/sessions.rs`

### /sessions/:thread_id/messages

**描述**: 向特定会话线程添加消息。

**源文件**: `cortex-mem-service/src/routes/sessions.rs`

**参数**:

- `thread_id` (字符串): 会话线程的唯一标识符

### /sessions/:thread_id/close

**描述**: 关闭会话线程。

**源文件**: `cortex-mem-service/src/routes/sessions.rs`

**参数**:

- `thread_id` (字符串): 会话线程的唯一标识符

### /search

**描述**: 使用分层向量检索执行语义搜索。

**源文件**: `cortex-mem-service/src/routes/search.rs`

### /automation/extract/:thread_id

**描述**: 触发从会话线程的记忆提取。

**源文件**: `cortex-mem-service/src/routes/automation.rs`

**参数**:

- `thread_id` (字符串): 会话线程的唯一标识符

### /automation/index/:thread_id

**描述**: 已弃用：索引特定线程。

**源文件**: `cortex-mem-service/src/routes/automation.rs`

**参数**:

- `thread_id` (字符串): 会话线程的唯一标识符

### /automation/index-all

**描述**: 已弃用：索引所有线程。

**源文件**: `cortex-mem-service/src/routes/automation.rs`

### /tenants

**描述**: 列出所有可用租户。

**源文件**: `cortex-mem-service/src/routes/tenants.rs`

### /tenants/switch

**描述**: 切换活动租户上下文。

**源文件**: `cortex-mem-service/src/routes/tenants.rs`

### /api/v2/*

**描述**: 所有v2 API路由嵌套在此前缀下；子路由继承父路径。

**源文件**: `cortex-mem-service/src/main.rs`

**参数**:

- `*path` (字符串): 匹配/api/v2下所有子路径段的通配符

## 集成建议

### HTTP API

使用认证请求和适当的错误处理与HTTP API集成。

**示例代码**:

```python
import requests

headers = {"Authorization": "Bearer YOUR_API_KEY"}
response = requests.post(
    "http://localhost:8085/api/v2/search",
    json={"query": "user preferences", "thread": "session_123", "limit": 5},
    headers=headers
)
print(response.json())
```

**最佳实践**:

- 生产环境始终使用HTTPS
- 在Authorization头中包含API密钥
- 验证响应状态码
- 为临时故障实施重试逻辑
- 高吞吐量使用连接池

### CLI

使用CLI进行本地开发和脚本任务。

**示例代码**:

```bash
#!/bin/bash
cortex-mem-cli --config ./config.toml search "recent meeting notes" --scope user --limit 3
```

**最佳实践**:

- 使用受限权限（600）存储配置文件
- 对敏感值使用环境变量
- 将CLI调用包装在shell脚本中以提高可重用性
- 日志输出用于审计跟踪
- 执行前验证输入

### MCP（stdio）

通过stdio连接到MCP服务器进行基于智能体的通信。

**示例代码**:

```bash
#!/bin/bash
cortex-mem-mcp --config config.toml
# 然后通过stdin发送JSON：
echo '{"method": "search", "params": {"query": "urgent task"}}' | cortex-mem-mcp --config config.toml
```

**最佳实践**:

- 对所有消息使用结构化JSON
- 实施消息成帧（如换行符分隔）
- 处理stdio缓冲区和超时
- 验证传入/传出消息的模式
- 使用日志调试IPC流

### Web UI（Svelte）

使用API端点与Svelte前端集成。

**示例代码**:

```typescript
import { writable } from 'svelte/store';

export const searchResults = writable([]);

export async function search(query) {
  const res = await fetch('/api/v2/search', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, thread: 'current_session' })
  });
  searchResults.set(await res.json());
}
```

**最佳实践**:

- 使用Svelte stores进行状态管理
- 在UI中实施加载/错误状态
- 对搜索输入进行防抖处理
- 本地缓存结果以减少API调用
- 在发送到LLM之前清理用户输入

---

**分析置信度**: 9.5/10
