# ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## 1. æ¶æ„æ¦‚è§ˆ (Architecture Overview)

**æ¶æ„è®¾è®¡ç†å¿µ**  
cortex-mem ç³»ç»Ÿä»¥â€œè®°å¿†å³æœåŠ¡â€ä¸ºæ ¸å¿ƒç†å¿µï¼Œè‡´åŠ›äºä¸ºAIæ™ºèƒ½ä½“æ„å»ºå¯æŒä¹…åŒ–ã€å¯æ£€ç´¢ã€å¯ä¼˜åŒ–çš„é•¿æœŸè®°å¿†èƒ½åŠ›ã€‚ç³»ç»Ÿé‡‡ç”¨â€œåˆ†å±‚è§£è€¦ã€èŒè´£å•ä¸€ã€æ¥å£æŠ½è±¡â€çš„è®¾è®¡å“²å­¦ï¼Œå°†è®°å¿†çš„æ™ºèƒ½å¤„ç†ã€æŒä¹…åŒ–å­˜å‚¨ã€å¤šæ¨¡å¼æ¥å…¥ä¸ç³»ç»Ÿæ”¯æ’‘è¿›è¡Œæ¸…æ™°åˆ†ç¦»ï¼Œç¡®ä¿æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸ä¾èµ–å…·ä½“å®ç°ï¼Œä»è€Œå®ç°é«˜å†…èšã€ä½è€¦åˆã€æ˜“æ‰©å±•çš„æ¶æ„ç›®æ ‡ã€‚ç³»ç»Ÿå¼ºè°ƒâ€œæ™ºèƒ½å¢å¼ºâ€è€Œéç®€å•å­˜å‚¨ï¼Œé€šè¿‡æ·±åº¦é›†æˆå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰å®ç°å¯¹éç»“æ„åŒ–å†…å®¹çš„è¯­ä¹‰ç†è§£ã€åˆ†ç±»ã€å»é‡ä¸é‡è¦æ€§è¯„ä¼°ï¼Œä½¿è®°å¿†æ•°æ®å…·å¤‡çŸ¥è¯†å¯†åº¦ä¸ä¸Šä¸‹æ–‡ä»·å€¼ã€‚

**æ ¸å¿ƒæ¶æ„æ¨¡å¼**  
ç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰** ä¸ºä¸»å¹²ï¼Œè¾…ä»¥**ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰**ã€**ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰**ã€**è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰** å’Œ**é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰**ï¼Œå½¢æˆå¤åˆå‹æ¶æ„é£æ ¼ï¼š

- **åˆ†å±‚æ¶æ„**ï¼šæ˜ç¡®åˆ’åˆ†ä¸ºæ¥å…¥å±‚ã€æ ¸å¿ƒä¸šåŠ¡å±‚ã€æ•°æ®è®¿é—®å±‚ä¸å¤–éƒ¨æœåŠ¡å±‚ï¼Œæ¯å±‚ä»…ä¾èµ–ä¸‹å±‚ï¼Œä¿éšœç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€‚
- **ä¾èµ–æ³¨å…¥**ï¼šæ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `VectorStore`ã€`LLMClient`ï¼‰å‡é€šè¿‡æ¥å£æŠ½è±¡ï¼Œç”±æ„é€ å‡½æ•°æ³¨å…¥ï¼Œä¾¿äºå•å…ƒæµ‹è¯•ä¸å®ç°æ›¿æ¢ï¼ˆå¦‚åˆ‡æ¢å‘é‡æ•°æ®åº“æˆ–LLMæä¾›å•†ï¼‰ã€‚
- **ç­–ç•¥æ¨¡å¼**ï¼šåœ¨è®°å¿†ä¼˜åŒ–æ¨¡å—ä¸­ï¼Œæ”¯æŒ `Full`ã€`Incremental`ã€`Deduplication`ã€`Quality` ç­‰å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼Œé€šè¿‡ç»Ÿä¸€æ¥å£è°ƒç”¨ï¼Œå®ç°ç­–ç•¥çš„åŠ¨æ€åˆ‡æ¢ä¸æ‰©å±•ã€‚
- **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šé€šè¿‡ `tracing` æ—¥å¿—ç³»ç»Ÿå®ç°æ“ä½œè¡Œä¸ºçš„é€æ˜åŒ–ç›‘æ§ï¼Œæ—¥å¿—äº‹ä»¶å¯è¢«å¤šä¸ªè§‚å¯Ÿè€…ï¼ˆå¦‚ç›‘æ§ç³»ç»Ÿã€è°ƒè¯•å·¥å…·ã€å®¡è®¡æ¨¡å—ï¼‰æ¶ˆè´¹ã€‚
- **é€‚é…å™¨æ¨¡å¼**ï¼š`Qdrant` å‘é‡æ•°æ®åº“ä½œä¸ºå¤–éƒ¨æœåŠ¡ï¼Œé€šè¿‡ `VectorStore` trait å°è£…ä¸ºç»Ÿä¸€æ¥å£ï¼Œä¸ºæœªæ¥æ”¯æŒ Pineconeã€Weaviate ç­‰æä¾›æ— ç¼è¿ç§»è·¯å¾„ã€‚

**æŠ€æœ¯æ ˆæ¦‚è¿°**  
| å±‚çº§ | æŠ€æœ¯ç»„ä»¶ | é€‰å‹è¯´æ˜ |
|------|----------|----------|
| **è¯­è¨€ä¸å¹³å°** | Rust | é«˜æ€§èƒ½ã€å†…å­˜å®‰å…¨ã€é›¶æˆæœ¬æŠ½è±¡ï¼Œé€‚åˆæ„å»ºåº•å±‚ç³»ç»ŸæœåŠ¡ |
| **æ ¸å¿ƒæ¡†æ¶** | `axum`ã€`clap`ã€`rmcp`ã€`ratatui` | åˆ†åˆ«ç”¨äºHTTPæœåŠ¡ã€CLIã€MCPåè®®ã€TUIç•Œé¢ï¼Œç”Ÿæ€æˆç†Ÿ |
| **LLMäº¤äº’** | OpenAI APIï¼ˆé€šè¿‡ `rig` æ¡†æ¶å°è£…ï¼‰ | æ”¯æŒæ–‡æœ¬ç”Ÿæˆã€åµŒå…¥å‘é‡ã€ç»“æ„åŒ–æå–ï¼Œå…·å¤‡é«˜ç²¾åº¦è¯­ä¹‰ç†è§£èƒ½åŠ› |
| **å‘é‡å­˜å‚¨** | Qdrant | ä¸“ä¸ºè¯­ä¹‰æœç´¢ä¼˜åŒ–ï¼Œæ”¯æŒè¿‡æ»¤ã€æ’åºã€æ‰¹é‡æ“ä½œï¼Œæ€§èƒ½ä¼˜å¼‚ |
| **é…ç½®ç®¡ç†** | `config` + TOML | æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–ã€é»˜è®¤å€¼ã€ç»“æ„åŒ–é…ç½®ï¼Œä¾¿äºè¿ç»´ |
| **æ—¥å¿—ä¸ç›‘æ§** | `tracing` + `tokio-tracing` | æ”¯æŒç»“æ„åŒ–æ—¥å¿—ã€åˆ†å¸ƒå¼è¿½è¸ªã€å¼‚æ­¥æ—¥å¿—è¾“å‡ºï¼Œæ·±åº¦é›†æˆRustç”Ÿæ€ |
| **å¹¶å‘æ¨¡å‹** | `async/await` + `tokio` | é«˜å¹¶å‘I/Oå¯†é›†å‹æ“ä½œï¼ˆå¦‚APIè¯·æ±‚ã€LLMè°ƒç”¨ï¼‰é«˜æ•ˆå¤„ç† |
| **æ•°æ®æ¨¡å‹** | Serde + JSON | ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œå…¼å®¹REST APIä¸å¤–éƒ¨ç³»ç»Ÿ |

ç³»ç»Ÿæ•´ä½“ä¸º**å•ä½“å¼å¤šæ¨¡å—æ¶æ„**ï¼ˆMonorepo with Modular Designï¼‰ï¼Œæ‰€æœ‰ç»„ä»¶ä½äºåŒä¸€ä»£ç ä»“åº“ï¼Œé€šè¿‡Cargoå·¥ä½œåŒºç®¡ç†ï¼Œé™ä½ä¾èµ–ç®¡ç†å¤æ‚åº¦ï¼ŒåŒæ—¶ä¿æŒé€»è¾‘éš”ç¦»ã€‚

---

## 2. ç³»ç»Ÿä¸Šä¸‹æ–‡ (System Context)

**ç³»ç»Ÿå®šä½ä¸ä»·å€¼**  
cortex-mem æ˜¯é¢å‘AIæ™ºèƒ½ä½“çš„**è®°å¿†ä¸­æ¢ç³»ç»Ÿ**ï¼Œå…¶æ ¸å¿ƒä»·å€¼åœ¨äºè§£å†³AIç³»ç»Ÿâ€œçŸ­æœŸè®°å¿†å¼ºã€é•¿æœŸè®°å¿†å¼±â€çš„æ ¹æœ¬æ€§ç¼ºé™·ã€‚é€šè¿‡ä¸ºæ™ºèƒ½ä½“æä¾›ç»“æ„åŒ–ã€å¯æ£€ç´¢ã€å¯ä¼˜åŒ–çš„è®°å¿†å­˜å‚¨èƒ½åŠ›ï¼Œç³»ç»Ÿæ˜¾è‘—æå‡æ™ºèƒ½ä½“çš„**ä¸Šä¸‹æ–‡è¿è´¯æ€§**ã€**ä¸ªæ€§åŒ–æœåŠ¡èƒ½åŠ›**ä¸**é•¿æœŸäº¤äº’ä½“éªŒ**ã€‚åœ¨å¯¹è¯ç³»ç»Ÿã€æ™ºèƒ½åŠ©æ‰‹ã€è‡ªåŠ¨åŒ–ä»£ç†ç­‰åœºæ™¯ä¸­ï¼Œcortex-mem ä½¿AIèƒ½å¤Ÿâ€œè®°ä½â€ç”¨æˆ·åå¥½ã€å†å²äº¤äº’ã€ä»»åŠ¡æµç¨‹ä¸å…³é”®äº‹å®ï¼Œé¿å…é‡å¤æé—®ä¸è®¤çŸ¥æ–­å±‚ï¼Œä»è€Œå®ç°ä»â€œå·¥å…·â€åˆ°â€œä¼™ä¼´â€çš„è´¨å˜ã€‚

**ç”¨æˆ·è§’è‰²ä¸åœºæ™¯**  
| ç”¨æˆ·è§’è‰² | ä½¿ç”¨åœºæ™¯ | æ ¸å¿ƒéœ€æ±‚ |
|----------|----------|----------|
| **AIæ™ºèƒ½ä½“å¼€å‘è€…** | åœ¨RIGã€LangChainç­‰æ¡†æ¶ä¸­é›†æˆè®°å¿†èƒ½åŠ› | æä¾›ç¨³å®šAPIã€æ”¯æŒå¤šç±»å‹è®°å¿†ã€è‡ªåŠ¨å»é‡ã€å¯é…ç½®ä¼˜åŒ–ç­–ç•¥ã€æ˜“äºè°ƒè¯• |
| **ç»ˆç«¯ç”¨æˆ·** | ä¸å…·å¤‡è®°å¿†çš„AIåŠ©æ‰‹å¯¹è¯ï¼ˆå¦‚å®¢æœã€å­¦ä¹ åŠ©æ‰‹ï¼‰ | è·å¾—ä¸ªæ€§åŒ–å“åº”ã€æ— éœ€é‡å¤ä¿¡æ¯ã€å¯¹è¯è‡ªç„¶è¿è´¯ã€è®°å¿†æŒä¹…ä¸é—å¿˜ |
| **ç³»ç»Ÿè¿ç»´äººå‘˜** | éƒ¨ç½²ã€ç›‘æ§ã€ç»´æŠ¤cortex-memæœåŠ¡ | æ¸…æ™°é…ç½®ã€å¥åº·æ£€æŸ¥ã€æ—¥å¿—å¯è§‚æµ‹ã€å†…å­˜ä¼˜åŒ–å·¥å…·ã€å¤šéƒ¨ç½²æ¨¡å¼æ”¯æŒ |

**å¤–éƒ¨ç³»ç»Ÿäº¤äº’**  
cortex-mem ä½œä¸ºâ€œè®°å¿†æœåŠ¡ä¸­é—´ä»¶â€ï¼Œä¸ä»¥ä¸‹å¤–éƒ¨ç³»ç»Ÿç´§å¯†åä½œï¼š

```mermaid
graph TD
    A[LLMæœåŠ¡] -->|APIè°ƒç”¨<br>åµŒå…¥ç”Ÿæˆ<br>åˆ†ç±»æå–<br>é‡è¦æ€§è¯„ä¼°| B[cortex-mem]
    C[Qdrantå‘é‡æ•°æ®åº“] -->|APIè°ƒç”¨<br>å‘é‡å­˜å‚¨<br>è¯­ä¹‰æœç´¢| B
    D[AIæ™ºèƒ½ä½“æ¡†æ¶<br>å¦‚RIG] -->|MCPåè®®<br>store_memory<br>search_memory| E[cortex-mem-mcp]
    F[ç»ˆç«¯ç”¨æˆ·ç•Œé¢<br>TUI/Web/Mobile] -->|HTTP API<br>RESTè¯·æ±‚| G[cortex-mem-service]
    H[é…ç½®ä¸­å¿ƒ/å¯†é’¥ç®¡ç†] -->|ç¯å¢ƒå˜é‡<br>Secrets| B

    style A fill:#f9f,stroke:#333
    style C fill:#bbf,stroke:#333
    style D fill:#f96,stroke:#333
    style F fill:#ff9,stroke:#333
    style H fill:#ddd,stroke:#333
    style B fill:#cfc,stroke:#333
    style E fill:#cfc,stroke:#333
    style G fill:#cfc,stroke:#333
```

- **LLMæœåŠ¡**ï¼šæ ¸å¿ƒæ™ºèƒ½å¼•æ“ï¼Œæä¾›è¯­ä¹‰ç†è§£èƒ½åŠ›ï¼Œç³»ç»Ÿä¸åŒ…å«LLMæœ¬èº«ï¼Œä»…é€šè¿‡APIè°ƒç”¨ã€‚
- **Qdrantå‘é‡æ•°æ®åº“**ï¼šæŒä¹…åŒ–å­˜å‚¨è½½ä½“ï¼Œè´Ÿè´£å‘é‡ç´¢å¼•ä¸ç›¸ä¼¼æ€§æ£€ç´¢ï¼Œç³»ç»Ÿä¸è´Ÿè´£å…¶è¿ç»´ã€‚
- **AIæ™ºèƒ½ä½“æ¡†æ¶**ï¼šé€šè¿‡MCPåè®®æ ‡å‡†åŒ–æ¥å…¥ï¼Œå®ç°è®°å¿†èƒ½åŠ›çš„å³æ’å³ç”¨ã€‚
- **ç»ˆç«¯ç”¨æˆ·ç•Œé¢**ï¼šé€šè¿‡HTTPæˆ–TUIä¸ç³»ç»Ÿäº¤äº’ï¼Œç•Œé¢UI/UXç”±å¤–éƒ¨ç³»ç»Ÿè´Ÿè´£ã€‚

**ç³»ç»Ÿè¾¹ç•Œå®šä¹‰**  
cortex-mem çš„**åŒ…å«èŒƒå›´**ä¸**æ’é™¤èŒƒå›´**æ˜ç¡®åˆ’åˆ†ï¼Œç¡®ä¿èšç„¦æ ¸å¿ƒä»·å€¼ï¼š

| åŒ…å«ç»„ä»¶ | æ’é™¤ç»„ä»¶ |
|----------|----------|
| è®°å¿†æ•°æ®çš„CRUDæ“ä½œ | å¤§è¯­è¨€æ¨¡å‹æœ¬èº«ï¼ˆå¦‚GPTã€Claudeï¼‰ |
| åŸºäºå‘é‡çš„è¯­ä¹‰æœç´¢ | å‘é‡æ•°æ®åº“çš„è¿ç»´ã€é›†ç¾¤ç®¡ç†ã€å¤‡ä»½æ¢å¤ |
| è®°å¿†åˆ†ç±»ä¸å…ƒæ•°æ®æå– | AIæ™ºèƒ½ä½“çš„å†³ç­–é€»è¾‘ã€æ¨ç†å¼•æ“ |
| è®°å¿†é‡è¦æ€§è¯„ä¼° | å‰ç«¯UI/UXè®¾è®¡ã€äº¤äº’åŠ¨ç”»ã€å“åº”å¼å¸ƒå±€ |
| é‡å¤è®°å¿†æ£€æµ‹ä¸åˆå¹¶ | èº«ä»½è®¤è¯ã€æƒé™æ§åˆ¶ã€RBACç³»ç»Ÿ |
| è®°å¿†ä¼˜åŒ–è®¡åˆ’ä¸æ‰§è¡Œ | ç½‘ç»œé€šä¿¡åè®®æ ˆã€æ“ä½œç³»ç»Ÿåº•å±‚ |
| CLIã€HTTPã€MCPã€TUIå¤šæ¨¡å¼æ¥å…¥ | æ•°æ®åº“è¿ç§»å·¥å…·ã€CI/CDæµæ°´çº¿ |

> **è¾¹ç•ŒåŸåˆ™**ï¼šcortex-mem ä¸æ˜¯AIæ™ºèƒ½ä½“ï¼Œä¹Ÿä¸æ˜¯æ•°æ®åº“ï¼Œè€Œæ˜¯**è¿æ¥AIä¸è®°å¿†çš„æ¡¥æ¢**ã€‚å®ƒä¸“æ³¨äºâ€œå¦‚ä½•è®©è®°å¿†å˜å¾—èªæ˜â€ï¼Œè€Œéâ€œå¦‚ä½•è®©AIæ€è€ƒâ€æˆ–â€œå¦‚ä½•å­˜å‚¨æ•°æ®â€ã€‚

---

## 3. å®¹å™¨è§†å›¾ (Container View)

cortex-mem ç³»ç»Ÿç”±**5ä¸ªæ ¸å¿ƒå®¹å™¨**ç»„æˆï¼Œæ¯ä¸ªå®¹å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯éƒ¨ç½²å•å…ƒï¼Œæ‹¥æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œä¸é€šä¿¡åè®®ã€‚

```mermaid
graph TD
    subgraph "å¤–éƒ¨ç³»ç»Ÿ"
        A[LLMæœåŠ¡] 
        B[Qdrantå‘é‡æ•°æ®åº“]
        C[AIæ™ºèƒ½ä½“æ¡†æ¶]
        D[ç»ˆç«¯ç”¨æˆ·ç•Œé¢]
    end

    subgraph "cortex-mem ç³»ç»Ÿ"
        subgraph "æ¥å…¥å±‚å®¹å™¨"
            E[cortex-mem-cli]
            F[cortex-mem-service]
            G[cortex-mem-mcp]
            H[examples/cortex-mem-tars]
        end

        subgraph "æ ¸å¿ƒä¸šåŠ¡å±‚å®¹å™¨"
            I[cortex-mem-core]
            J[cortex-mem-config]
        end

        subgraph "å·¥å…·æ”¯æ’‘å®¹å™¨"
            K[cortex-mem-rig]
        end
    end

    E -->|è°ƒç”¨MemoryManager API| I
    F -->|HTTP POST/GET| I
    G -->|MCPåè®®| I
    H -->|è°ƒç”¨MemoryTool| K
    K -->|è°ƒç”¨MemoryManager API| I
    J -->|æä¾›é…ç½®| I
    I -->|APIè°ƒç”¨| A
    I -->|APIè°ƒç”¨| B

    style A fill:#f9f,stroke:#333
    style B fill:#bbf,stroke:#333
    style C fill:#f96,stroke:#333
    style D fill:#ff9,stroke:#333
    style E fill:#e8f5e8,stroke:#333
    style F fill:#e8f5e8,stroke:#333
    style G fill:#e8f5e8,stroke:#333
    style H fill:#e8f5e8,stroke:#333
    style I fill:#d4edda,stroke:#333
    style J fill:#d4edda,stroke:#333
    style K fill:#fff3cd,stroke:#333

    classDef access fill:#e8f5e8,stroke:#333;
    classDef core fill:#d4edda,stroke:#333;
    classDef support fill:#fff3cd,stroke:#333;
    classDef external fill:#f9f,stroke:#333;

    class E,F,G,H access
    class I,J core
    class K support
    class A,B,C,D external
```

### é¢†åŸŸæ¨¡å—åˆ’åˆ†ä¸æ¶æ„

| å®¹å™¨ | ç±»å‹ | èŒè´£ | æŠ€æœ¯å®ç° | é€šä¿¡åè®® |
|------|------|------|----------|----------|
| **cortex-mem-core** | æ ¸å¿ƒä¸šåŠ¡å®¹å™¨ | è®°å¿†å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šå­˜å‚¨ã€æ£€ç´¢ã€å¢å¼ºã€ä¼˜åŒ– | Rustæ¨¡å—ï¼ŒåŒ…å« `MemoryManager`ã€`LLMClient`ã€`VectorStore`ã€`OptimizationEngine` | å†…éƒ¨æ¨¡å—è°ƒç”¨ï¼ˆRustå‡½æ•°ï¼‰ |
| **cortex-mem-config** | æ”¯æ’‘å®¹å™¨ | é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹ï¼ˆLLMã€Qdrantã€ä¼˜åŒ–ç­–ç•¥ç­‰ï¼‰ | TOMLè§£æå™¨ + é…ç½®ç»“æ„ä½“ + ç¯å¢ƒå˜é‡è¦†ç›– | ä¾èµ–æ³¨å…¥ï¼ˆæ„é€ å‡½æ•°ä¼ å…¥ï¼‰ |
| **cortex-mem-cli** | æ¥å…¥å®¹å™¨ | å‘½ä»¤è¡Œäº¤äº’ï¼Œä¾›å¼€å‘è€…è°ƒè¯•ä¸ç®¡ç†è®°å¿† | `clap` è§£æå‘½ä»¤ï¼Œè°ƒç”¨ `MemoryManager` | æœ¬åœ°è¿›ç¨‹è°ƒç”¨ |
| **cortex-mem-service** | æ¥å…¥å®¹å™¨ | æä¾›RESTful HTTP APIï¼Œä¾›å¤–éƒ¨ç³»ç»Ÿé›†æˆ | `axum` æ¡†æ¶ï¼ŒJSON over HTTPï¼Œæ”¯æŒCORS | HTTP/HTTPS (REST) |
| **cortex-mem-mcp** | æ¥å…¥å®¹å™¨ | å®ç°MCPåè®®ï¼Œä¸ºAIæ™ºèƒ½ä½“æ¡†æ¶æä¾›æ ‡å‡†æ¥å£ | `rmcp` åº“ï¼Œæ ‡å‡†è¾“å…¥/è¾“å‡ºæµé€šä¿¡ | MCPåè®®ï¼ˆstdin/stdoutï¼‰ |
| **examples/cortex-mem-tars** | æ¥å…¥å®¹å™¨ | å…¨å±ç»ˆç«¯ç•Œé¢ï¼Œç”¨äºå®æ—¶å¯¹è¯ä¸è®°å¿†äº¤äº’ | `ratatui` + `crossterm`ï¼Œæµå¼æ¸²æŸ“ | æœ¬åœ°è¿›ç¨‹è°ƒç”¨ `cortex-mem-core` |
| **cortex-mem-rig** | å·¥å…·å®¹å™¨ | æä¾›ä¸RIGæ¡†æ¶é›†æˆçš„å·¥å…·æŠ½è±¡ï¼ˆMemoryToolã€Processorï¼‰ | Ruståº“ï¼Œå°è£… `MemoryManager` æ¥å£ | Rustæ¨¡å—ä¾èµ– |

### å­˜å‚¨è®¾è®¡

- **ä¸»å­˜å‚¨**ï¼š**Qdrantå‘é‡æ•°æ®åº“**  
  - å­˜å‚¨ç»“æ„ï¼šæ¯ä¸ªè®°å¿†ä¸ºä¸€ä¸ªå‘é‡ç‚¹ï¼ˆPointï¼‰ï¼ŒåŒ…å«ï¼š
    - `embedding`: 1536ç»´ï¼ˆOpenAI text-embedding-3-smallï¼‰æµ®ç‚¹å‘é‡
    - `payload`: JSONæ ¼å¼å…ƒæ•°æ®ï¼ˆè§5.6èŠ‚ï¼‰
    - `id`: UUIDå­—ç¬¦ä¸²
  - ç´¢å¼•ç­–ç•¥ï¼šHNSWï¼ˆHierarchical Navigable Small Worldï¼‰ç´¢å¼•ï¼Œæ”¯æŒè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢
  - è¿‡æ»¤èƒ½åŠ›ï¼šæ”¯æŒåŸºäº `metadata.agent_id`ã€`memory_type`ã€`importance_score` ç­‰å­—æ®µçš„å¤åˆæŸ¥è¯¢
  - æ€§èƒ½ï¼šå•èŠ‚ç‚¹Qdrantæ”¯æŒæ¯ç§’500+æ¬¡è¯­ä¹‰æœç´¢ï¼Œå»¶è¿Ÿ<100msï¼ˆ10Kè®°å¿†è§„æ¨¡ï¼‰

- **è¾…åŠ©å­˜å‚¨**ï¼š**å†…å­˜ç¼“å­˜ï¼ˆå¾…æ‰©å±•ï¼‰**  
  - å½“å‰æœªå®ç°ï¼Œä½†æ¶æ„é¢„ç•™æ‰©å±•ç‚¹ï¼ˆå»ºè®®ä½¿ç”¨ `tokio::sync::RwLock` + LRUç¼“å­˜ï¼‰
  - æœªæ¥å¯ç¼“å­˜é«˜é¢‘è®¿é—®çš„è®°å¿†ï¼ˆå¦‚æœ€è¿‘å¯¹è¯ã€ç”¨æˆ·åå¥½ï¼‰ï¼Œé™ä½Qdrantè´Ÿè½½

### é¢†åŸŸæ¨¡å—é—´é€šä¿¡

| é€šä¿¡æ–¹å‘ | åè®® | è¯´æ˜ |
|----------|------|------|
| æ¥å…¥å±‚ â†’ æ ¸å¿ƒå±‚ | **å‡½æ•°è°ƒç”¨**ï¼ˆRustï¼‰ | CLIã€TUIã€MCPã€HTTPæœåŠ¡å‡é€šè¿‡å¯¼å…¥ `cortex-mem-core` crateï¼Œè°ƒç”¨ `MemoryManager` çš„å…¬å¼€æ–¹æ³•ï¼ˆå¦‚ `add_memory()`ã€`search()`ï¼‰ |
| æ ¸å¿ƒå±‚ â†’ LLM | **HTTP API** | `LLMClient` ä½¿ç”¨ `reqwest` å‘é€JSONè¯·æ±‚è‡³OpenAI APIï¼Œæ¥æ”¶ç»“æ„åŒ–å“åº” |
| æ ¸å¿ƒå±‚ â†’ Qdrant | **HTTP API** | `VectorStore` ä½¿ç”¨ `qdrant-client` Rust SDKï¼Œè°ƒç”¨ `upsert`ã€`search`ã€`delete` ç­‰API |
| æ ¸å¿ƒå±‚ â†’ é…ç½® | **ä¾èµ–æ³¨å…¥** | `MemoryManager` æ„é€ æ—¶æ¥æ”¶ `MemoryConfig` å®ä¾‹ï¼Œé…ç½®é¡¹åœ¨å¯åŠ¨æ—¶åŠ è½½ |
| ä¼˜åŒ–å¼•æ“ â†’ è®°å¿†ç®¡ç† | **å‡½æ•°è°ƒç”¨** | `ExecutionEngine` è°ƒç”¨ `MemoryManager::delete()`ã€`MemoryManager::merge()` æ‰§è¡Œæ“ä½œ |
| å·¥å…·å®¹å™¨ â†’ æ ¸å¿ƒå±‚ | **Rustæ¨¡å—ä¾èµ–** | `cortex-mem-rig` ä½œä¸ºåº“è¢« `cortex-mem-mcp` æˆ– `cortex-mem-tars` å¼•ç”¨ï¼Œé—´æ¥è°ƒç”¨æ ¸å¿ƒåŠŸèƒ½ |

> **é€šä¿¡åŸåˆ™**ï¼š**æ‰€æœ‰å¤–éƒ¨äº¤äº’å‡é€šè¿‡æ¥å£æŠ½è±¡**ï¼Œå†…éƒ¨è°ƒç”¨ç›´æ¥ä½¿ç”¨å…·ä½“å®ç°ï¼Œç¡®ä¿çµæ´»æ€§ä¸æ€§èƒ½å¹³è¡¡ã€‚

---

## 4. ç»„ä»¶è§†å›¾ (Component View)

### æ ¸å¿ƒåŠŸèƒ½ç»„ä»¶

```mermaid
graph TD
    subgraph "cortex-mem-core"
        A[MemoryManager] --> B[LLMClient]
        A --> C[VectorStore]
        A --> D[ClassificationEngine]
        A --> E[ImportanceEvaluator]
        A --> F[DeduplicationChecker]
        A --> G[SearchService]
        A --> H[OptimizationDetector]
        A --> I[OptimizationAnalyzer]
        A --> J[ExecutionEngine]
        A --> K[ResultReporter]

        B --> L[LLMExtractor]
        B --> M[EmbeddingGenerator]
        C --> N[QdrantAdapter]
        D --> O[TopicExtractor]
        E --> P[ScoringModel]
        F --> Q[HashComparator]
        G --> R[SemanticSearch]
        H --> S[DuplicateScanner]
        H --> T[QualityAssessor]
        H --> U[StalenessDetector]
        I --> V[StrategySelector]
        J --> W[BatchProcessor]
        J --> X[TransactionManager]
        K --> Y[ReportFormatter]

        style A fill:#d4edda,stroke:#333
        style B fill:#cce5ff,stroke:#333
        style C fill:#cce5ff,stroke:#333
        style D fill:#cce5ff,stroke:#333
        style E fill:#cce5ff,stroke:#333
        style F fill:#cce5ff,stroke:#333
        style G fill:#cce5ff,stroke:#333
        style H fill:#cce5ff,stroke:#333
        style I fill:#cce5ff,stroke:#333
        style J fill:#cce5ff,stroke:#333
        style K fill:#cce5ff,stroke:#333
        style L fill:#f8d7da,stroke:#333
        style M fill:#f8d7da,stroke:#333
        style N fill:#f8d7da,stroke:#333
        style O fill:#f8d7da,stroke:#333
        style P fill:#f8d7da,stroke:#333
        style Q fill:#f8d7da,stroke:#333
        style R fill:#f8d7da,stroke:#333
        style S fill:#f8d7da,stroke:#333
        style T fill:#f8d7da,stroke:#333
        style U fill:#f8d7da,stroke:#333
        style V fill:#f8d7da,stroke:#333
        style W fill:#f8d7da,stroke:#333
        style X fill:#f8d7da,stroke:#333
        style Y fill:#f8d7da,stroke:#333
    end

    classDef coreComponent fill:#d4edda,stroke:#333;
    classDef serviceComponent fill:#cce5ff,stroke:#333;
    classDef utilityComponent fill:#f8d7da,stroke:#333;

    class A coreComponent
    class B,C,D,E,F,G,H,I,J,K serviceComponent
    class L,M,N,O,P,Q,R,S,T,U,V,W,X,Y utilityComponent
```

| ç»„ä»¶ | èŒè´£ | å…³é”®å®ç° | ä¾èµ– |
|------|------|----------|------|
| **MemoryManager** | æ ¸å¿ƒåè°ƒå™¨ï¼Œè®°å¿†æ“ä½œå…¥å£ | å®ç° `add_memory()`ã€`search()`ã€`delete()`ã€`optimize()` | LLMClientã€VectorStoreã€Config |
| **LLMClient** | å°è£…LLMé€šä¿¡ | ä½¿ç”¨ `rig` å°è£…OpenAI APIï¼Œæ”¯æŒæµå¼ä¸ç»“æ„åŒ–å“åº” | HTTPå®¢æˆ·ç«¯ã€é…ç½® |
| **VectorStore** | å‘é‡å­˜å‚¨é€‚é…å™¨ | å®ç° `QdrantAdapter`ï¼Œå°è£… `qdrant-client` | QdrantæœåŠ¡ |
| **ClassificationEngine** | è®°å¿†åˆ†ç±» | è°ƒç”¨LLMç”Ÿæˆ `memory_type`ï¼ˆConversational/Factualç­‰ï¼‰ | LLMClient |
| **ImportanceEvaluator** | é‡è¦æ€§è¯„åˆ† | åŸºäºå†…å®¹é•¿åº¦ã€å…³é”®è¯å¯†åº¦ã€ç”¨æˆ·IDã€æ—¶é—´æˆ³ç­‰ç»´åº¦åŠ æƒè®¡ç®— | LLMClientã€Config |
| **DeduplicationChecker** | é‡å¤æ£€æµ‹ | è®¡ç®—å†…å®¹å“ˆå¸Œï¼ˆSHA-256ï¼‰ï¼Œæ¯”å¯¹å·²æœ‰è®°å¿† | VectorStore |
| **SearchService** | è¯­ä¹‰æœç´¢ | æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢ + å…ƒæ•°æ®è¿‡æ»¤ + æ’åº | VectorStore |
| **OptimizationDetector** | é—®é¢˜æ‰«æ | æ‰«æè®°å¿†åº“ï¼Œè¯†åˆ«é‡å¤ã€ä½è´¨é‡ã€è¿‡æ—¶ã€åˆ†ç±»é”™è¯¯ | VectorStoreã€LLMClient |
| **OptimizationAnalyzer** | ç­–ç•¥åˆ¶å®š | æ ¹æ®æ£€æµ‹ç»“æœï¼Œé€‰æ‹©ä¼˜åŒ–ç­–ç•¥ï¼ˆFull/Incrementalç­‰ï¼‰ | Configã€Detector |
| **ExecutionEngine** | æ“ä½œæ‰§è¡Œ | æ‰¹é‡æ‰§è¡Œåˆå¹¶ã€åˆ é™¤ã€å½’æ¡£ï¼Œæ”¯æŒäº‹åŠ¡å›æ»š | MemoryManager |
| **ResultReporter** | æŠ¥å‘Šç”Ÿæˆ | è¾“å‡ºJSONæˆ–æ–‡æœ¬æ ¼å¼ä¼˜åŒ–æŠ¥å‘Šï¼Œå«ç»Ÿè®¡ä¸å»ºè®® | Config |

### æŠ€æœ¯æ”¯æ’‘ç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®å®ç° |
|------|------|----------|
| **ConfigurationManager** | é…ç½®åŠ è½½ä¸éªŒè¯ | è¯»å– `config.toml`ï¼Œæ”¯æŒé»˜è®¤å€¼ã€ç¯å¢ƒå˜é‡è¦†ç›–ã€ç»“æ„æ ¡éªŒï¼ˆ`serde` + `config`ï¼‰ |
| **LoggingSystem** | æ—¥å¿—è®°å½• | ä½¿ç”¨ `tracing` æ¡†æ¶ï¼Œè¾“å‡ºINFO/WARN/ERRORæ—¥å¿—ï¼Œæ”¯æŒJSONæ ¼å¼ã€æ–‡ä»¶è½®è½¬ |
| **ErrorHandling** | ç»Ÿä¸€é”™è¯¯ä½“ç³» | å®šä¹‰ `CortexMemError` æšä¸¾ï¼ŒåŒ…å« `LLMTimeout`ã€`QdrantConnectionFailed`ã€`InvalidMemoryFormat` ç­‰ |
| **InitManager** | ç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ– | é¡ºåºåŠ è½½é…ç½® â†’ åˆå§‹åŒ–æ—¥å¿— â†’ è¿æ¥Qdrant â†’ éªŒè¯é›†åˆç»“æ„ â†’ å¯åŠ¨æœåŠ¡ |

### ç»„ä»¶äº¤äº’å…³ç³»

```mermaid
sequenceDiagram
    participant CLI as cortex-mem-cli
    participant MM as MemoryManager
    participant LLM as LLMClient
    participant Q as VectorStore
    participant OD as OptimizationDetector
    participant EA as ExecutionEngine
    participant RR as ResultReporter

    CLI->>MM: add_memory(content="ç”¨æˆ·è¯´ï¼šæˆ‘è®¨åŒä¸‹é›¨")
    MM->>LLM: embed(content)
    LLM-->>MM: embedding_vector[1536]
    MM->>LLM: classify_memory(content)
    LLM-->>MM: memory_type=Personal
    MM->>LLM: extract_keywords(content)
    LLM-->>MM: keywords=["è®¨åŒ","ä¸‹é›¨"]
    MM->>LLM: evaluate_importance(memory)
    LLM-->>MM: importance_score=0.87
    MM->>MM: check_duplicate(content_hash)
    alt æ— é‡å¤
        MM->>Q: upsert_point(embedding, metadata)
        Q-->>MM: success
        MM-->>CLI: {"id":"uuid-123", "status":"created"}
    else æœ‰é‡å¤
        MM->>MM: merge_memories(existing, new)
        MM->>Q: upsert_point(merged_embedding, merged_metadata)
        Q-->>MM: success
        MM-->>CLI: {"id":"uuid-123", "status":"merged"}
    end

    CLI->>MM: optimize()
    MM->>OD: scan_all_memories()
    OD->>OD: detect_duplicates()
    OD->>OD: detect_low_quality()
    OD->>OD: detect_stale()
    OD-->>MM: issues=[{type: duplicate, count: 5}, ...]
    MM->>EA: select_strategy(Full)
    EA->>MM: delete(id_list)
    EA->>MM: merge(id_list)
    EA->>MM: reclassify(id_list)
    EA-->>MM: results=[{action: delete, count: 3}, ...]
    MM->>RR: generate_report(results)
    RR-->>CLI: "ä¼˜åŒ–å®Œæˆï¼šåˆ é™¤3æ¡ä½è´¨é‡è®°å¿†ï¼Œåˆå¹¶5æ¡é‡å¤è®°å¿†ï¼Œå½’æ¡£2æ¡è¿‡æ—¶è®°å¿†"
```

> **å…³é”®äº¤äº’åŸåˆ™**ï¼š
> - æ‰€æœ‰æ™ºèƒ½å¤„ç†ï¼ˆåˆ†ç±»ã€è¯„åˆ†ã€å»é‡ï¼‰å‡é€šè¿‡LLMå®Œæˆï¼Œç¡®ä¿è¯­ä¹‰å‡†ç¡®æ€§ã€‚
> - æ‰€æœ‰æŒä¹…åŒ–æ“ä½œå‡é€šè¿‡ `VectorStore` æ¥å£ï¼Œå®ç°å­˜å‚¨è§£è€¦ã€‚
> - ä¼˜åŒ–æµç¨‹ä¸º**å¼‚æ­¥æ‰¹å¤„ç†**ï¼Œä¸å½±å“ä¸»æµç¨‹å“åº”ã€‚

---

## 5. å…³é”®æµç¨‹ (Key Processes)

### æ ¸å¿ƒåŠŸèƒ½æµç¨‹ï¼šè®°å¿†åˆ›å»ºæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·/ç³»ç»Ÿ
    participant CLI as cortex-mem-cli
    participant MM as MemoryManager
    participant LLM as LLMClient
    participant Q as Qdrant
    participant Config as Configuration

    User->>CLI: add "ä»Šå¤©å’ŒAIèŠäº†å…³äºæ°”å€™å˜åŒ–çš„è§£å†³æ–¹æ¡ˆ"
    CLI->>MM: add_memory(content, metadata={agent_id: "chatbot-01"})
    MM->>Config: load_config()
    Config-->>MM: config{llm_model: "text-embedding-3-small", importance_threshold: 0.7}
    MM->>LLM: embed(content)
    LLM-->>MM: embedding_vector[1536]
    MM->>LLM: classify_memory(content)
    LLM-->>MM: memory_type: Factual
    MM->>LLM: extract_keywords(content)
    LLM-->>MM: keywords: ["æ°”å€™å˜åŒ–", "è§£å†³æ–¹æ¡ˆ", "ç¢³ä¸­å’Œ"]
    MM->>LLM: evaluate_importance(content, metadata)
    LLM-->>MM: importance_score: 0.92
    MM->>MM: hash = sha256(content)
    MM->>Q: search_by_hash(hash)
    alt æœªæ‰¾åˆ°é‡å¤
        MM->>Q: upsert_point(
            id: uuid,
            embedding: [1536],
            payload: {
                content: "...",
                metadata: {
                    agent_id: "chatbot-01",
                    memory_type: "Factual",
                    importance_score: 0.92,
                    keywords: [...],
                    hash: "abc...",
                    created_at: "2025-04-05T10:00:00Z"
                }
            }
        )
        Q-->>MM: success
        MM-->>CLI: {"status": "created", "id": "uuid-123"}
    else æ‰¾åˆ°é‡å¤
        MM->>Q: get_existing_point(id)
        MM->>MM: merge_memories(existing, new)
        MM->>Q: upsert_point(merged_embedding, merged_metadata)
        Q-->>MM: success
        MM-->>CLI: {"status": "merged", "id": "uuid-123", "merged_from": ["uuid-456"]}
    end
```

### æŠ€æœ¯å¤„ç†æµç¨‹ï¼šè®°å¿†ä¼˜åŒ–æµç¨‹

```mermaid
graph TD
    A[è§¦å‘ä¼˜åŒ–] --> B[OptimizationDetector]
    B --> C{æ£€æµ‹é—®é¢˜}
    C --> D[é‡å¤è®°å¿†]
    C --> E[ä½è´¨é‡è®°å¿†<br>ï¼ˆå†…å®¹<50å­—ã€æ— å…³é”®è¯ï¼‰]
    C --> F[è¿‡æ—¶è®°å¿†<br>ï¼ˆåˆ›å»ºæ—¶é—´>180å¤©ï¼‰]
    C --> G[åˆ†ç±»ä¸å½“<br>ï¼ˆLLMé‡è¯„ï¼‰]
    C --> H[ç©ºé—´æ•ˆç‡ä½<br>ï¼ˆå†—ä½™å‘é‡ï¼‰]

    D --> I[OptimizationAnalyzer]
    E --> I
    F --> I
    G --> I
    H --> I

    I --> J[ç”Ÿæˆä¼˜åŒ–è®¡åˆ’]
    J --> K[ExecutionEngine]
    K --> L[æ‰§è¡Œåˆå¹¶<br>ï¼ˆé‡å¤è®°å¿†ï¼‰]
    K --> M[æ‰§è¡Œåˆ é™¤<br>ï¼ˆä½è´¨é‡/è¿‡æ—¶ï¼‰]
    K --> N[æ‰§è¡Œé‡åˆ†ç±»<br>ï¼ˆåˆ†ç±»ä¸å½“ï¼‰]
    K --> O[æ‰§è¡Œå½’æ¡£<br>ï¼ˆå¯é€‰ï¼‰]

    L --> P[ResultReporter]
    M --> P
    N --> P
    O --> P

    P --> Q[ç”ŸæˆæŠ¥å‘Š<br>JSON/æ–‡æœ¬]
    Q --> R[è¾“å‡ºåˆ°æ§åˆ¶å°/æ—¥å¿—æ–‡ä»¶]

    style A fill:#f9f,stroke:#333
    style B fill:#cce5ff,stroke:#333
    style C fill:#cce5ff,stroke:#333
    style I fill:#cce5ff,stroke:#333
    style K fill:#cce5ff,stroke:#333
    style P fill:#cce5ff,stroke:#333
    style Q fill:#cce5ff,stroke:#333
    style R fill:#f9f,stroke:#333
```

### æ•°æ®æµè½¬è·¯å¾„

1. **è¾“å…¥**ï¼šç”¨æˆ·è¾“å…¥æ–‡æœ¬ â†’ CLI/HTTP/MCPæ¥æ”¶ â†’ è½¬ä¸º `MemoryInput` ç»“æ„ä½“
2. **å¢å¼º**ï¼š`MemoryManager` è°ƒç”¨ `LLMClient` ç”ŸæˆåµŒå…¥ã€åˆ†ç±»ã€å…³é”®è¯ã€é‡è¦æ€§è¯„åˆ†
3. **å»é‡**ï¼šè®¡ç®—å†…å®¹å“ˆå¸Œï¼ŒæŸ¥è¯¢Qdrantæ˜¯å¦å­˜åœ¨ç›¸åŒå“ˆå¸Œ
4. **å­˜å‚¨**ï¼šåˆå¹¶æˆ–æ–°å»º `Memory` å®ä½“ï¼Œåºåˆ—åŒ–ä¸ºJSON Payloadï¼Œè°ƒç”¨Qdrant `upsert`
5. **æ£€ç´¢**ï¼šç”¨æˆ·æŸ¥è¯¢ â†’ ç”ŸæˆæŸ¥è¯¢åµŒå…¥ â†’ Qdrantè¯­ä¹‰æœç´¢ â†’ è¿‡æ»¤å…ƒæ•°æ® â†’ æ’åº â†’ è¿”å›å®Œæ•´è®°å¿†
6. **ä¼˜åŒ–**ï¼šå®šæ—¶ä»»åŠ¡è§¦å‘ â†’ æ‰«æå…¨åº“ â†’ ç”Ÿæˆé—®é¢˜åˆ—è¡¨ â†’ æ‰§è¡Œæ“ä½œ â†’ è¾“å‡ºæŠ¥å‘Š

### å¼‚å¸¸å¤„ç†æœºåˆ¶

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | æ¢å¤æœºåˆ¶ |
|----------|----------|----------|
| **LLMæœåŠ¡è¶…æ—¶/å¤±è´¥** | è¿”å› `CortexMemError::LLMUnavailable`ï¼Œè®°å½•æ—¥å¿—ï¼Œç¼“å­˜è¯·æ±‚ï¼ˆå¯é€‰ï¼‰ | é‡è¯•3æ¬¡ï¼ˆæŒ‡æ•°é€€é¿ï¼‰ï¼Œé™çº§ä¸ºâ€œä»…å­˜å‚¨åŸå§‹å†…å®¹â€ |
| **Qdrantè¿æ¥ä¸­æ–­** | è¿”å› `CortexMemError::VectorStoreUnavailable`ï¼Œé˜»å¡å†™å…¥ï¼Œå…è®¸è¯»å–ï¼ˆè‹¥ç¼“å­˜ï¼‰ | æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè§¦å‘å‘Šè­¦ï¼Œè‡ªåŠ¨é‡è¿ |
| **é…ç½®é”™è¯¯** | å¯åŠ¨é˜¶æ®µæ ¡éªŒå¤±è´¥ï¼Œè¿›ç¨‹é€€å‡ºï¼Œè¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ | æä¾› `--validate-config` å‘½ä»¤ä¾›è¿ç»´é¢„æ£€ |
| **å†…å­˜ä¸è¶³** | ä½¿ç”¨ `tokio::sync::mpsc` é™åˆ¶å¹¶å‘è¯·æ±‚æ•°ï¼Œé¿å…OOM | ç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œè®¾ç½®GCé˜ˆå€¼ |
| **æ•°æ®æ ¼å¼é”™è¯¯** | ååºåˆ—åŒ–å¤±è´¥æ—¶è¿”å› `400 Bad Request`ï¼Œæ‹’ç»å†™å…¥ | æä¾›JSON Schemaæ ¡éªŒï¼Œå‰ç«¯/CLIé¢„æ ¡éªŒ |

> **å…¨å±€ç­–ç•¥**ï¼šæ‰€æœ‰å¤–éƒ¨ä¾èµ–å‡é‡‡ç”¨**æ–­è·¯å™¨æ¨¡å¼**ï¼ˆCircuit Breakerï¼‰è®¾è®¡ï¼Œå¤±è´¥åè¿›å…¥ç†”æ–­çŠ¶æ€ï¼Œé¿å…é›ªå´©ã€‚

---

## 6. æŠ€æœ¯å®ç° (Technical Implementation)

### æ ¸å¿ƒæ¨¡å—å®ç°

#### MemoryManagerï¼ˆè®°å¿†ç®¡ç†å™¨ï¼‰

```rust
pub struct MemoryManager {
    vector_store: Box<dyn VectorStore>,
    llm_client: Box<dyn LLMClient>,
    config: MemoryConfig,
    deduplication_checker: DeduplicationChecker,
    classification_engine: ClassificationEngine,
    importance_evaluator: ImportanceEvaluator,
}

impl MemoryManager {
    pub fn add_memory(&self, content: &str, metadata: MemoryMetadata) -> Result<MemoryId, CortexMemError> {
        // 1. ç”ŸæˆåµŒå…¥å‘é‡
        let embedding = self.llm_client.embed(content).await?;
        
        // 2. æ™ºèƒ½å¢å¼º
        let memory_type = self.classification_engine.classify(content).await?;
        let keywords = self.llm_client.extract_keywords(content).await?;
        let importance_score = self.importance_evaluator.evaluate(content, &metadata).await?;
        
        // 3. å»é‡æ£€æŸ¥
        let hash = sha256(content);
        if let Some(existing_id) = self.deduplication_checker.find_duplicate(hash).await? {
            return self.merge_memories(existing_id, content, embedding, metadata).await;
        }
        
        // 4. å­˜å‚¨
        let memory = Memory {
            id: Uuid::new_v4().to_string(),
            content: content.to_string(),
            embedding,
            metadata: MemoryMetadata {
                hash,
                memory_type,
                importance_score,
                keywords,
                ..metadata
            },
            created_at: Utc::now(),
            updated_at: Utc::now(),
        };
        
        self.vector_store.upsert_point(memory).await?;
        Ok(memory.id)
    }
}
```

#### LLMClientï¼ˆå¤§è¯­è¨€æ¨¡å‹å®¢æˆ·ç«¯ï¼‰

- **å°è£…ç­–ç•¥**ï¼šä½¿ç”¨ `trait LLMClient` å®šä¹‰æ¥å£ï¼Œå®ç° `OpenAIClient`ã€`MockClient`ï¼ˆç”¨äºæµ‹è¯•ï¼‰
- **ç»“æ„åŒ–æå–**ï¼šé€šè¿‡æç¤ºè¯æ¨¡æ¿å¼ºåˆ¶LLMè¿”å›JSONæ ¼å¼ï¼Œå¦‚ï¼š
  ```text
  è¯·å°†ä»¥ä¸‹å†…å®¹åˆ†ç±»ä¸ºä»¥ä¸‹ç±»å‹ä¹‹ä¸€ï¼šConversational, Procedural, Factual, Semantic, Episodic, Personalã€‚
  è¿”å›JSONæ ¼å¼ï¼š{"memory_type": "xxx"}
  ```
- **åµŒå…¥ç”Ÿæˆ**ï¼šè°ƒç”¨ `text-embedding-3-small`ï¼Œç»´åº¦1536ï¼Œä½¿ç”¨ `reqwest` å¼‚æ­¥è¯·æ±‚

#### VectorStoreï¼ˆå‘é‡å­˜å‚¨é€‚é…å™¨ï¼‰

```rust
pub trait VectorStore {
    async fn upsert_point(&self, memory: Memory) -> Result<(), VectorStoreError>;
    async fn search(&self, query_embedding: &[f32], filter: MetadataFilter, limit: usize) -> Result<Vec<Memory>, VectorStoreError>;
    async fn delete_by_id(&self, id: &str) -> Result<(), VectorStoreError>;
    async fn health_check(&self) -> Result<bool, VectorStoreError>;
}

pub struct QdrantAdapter {
    client: qdrant_client::Qdrant,
    collection_name: String,
}

impl VectorStore for QdrantAdapter {
    async fn upsert_point(&self, memory: Memory) -> Result<(), VectorStoreError> {
        let point = PointStruct::new(
            memory.id.clone(),
            memory.embedding,
            serde_json::to_value(memory.metadata).map_err(VectorStoreError::Serialization)?,
        );
        self.client
            .upsert_points(self.collection_name.clone(), vec![point], None)
            .await
            .map_err(VectorStoreError::from)?;
        Ok(())
    }
}
```

### å…³é”®ç®—æ³•è®¾è®¡

#### é‡è¦æ€§è¯„åˆ†ç®—æ³•ï¼ˆImportanceEvaluatorï¼‰

é‡‡ç”¨**å¤šç»´åº¦åŠ æƒæ¨¡å‹**ï¼š

```rust
fn calculate_importance(content: &str, metadata: &MemoryMetadata) -> f32 {
    let length_score = (content.len() as f32 / 1000.0).min(1.0); // æœ€å¤§1.0
    let keyword_density = (metadata.keywords.len() as f32 / content.split_whitespace().count()) * 2.0; // æœ€å¤§1.0
    let user_specificity = if metadata.user_id.is_some() { 0.3 } else { 0.0 };
    let recency_score = (Utc::now().signed_duration_since(metadata.created_at).num_hours() as f32 / 24.0).neg().exp() * 0.5; // æŒ‡æ•°è¡°å‡
    let llm_score = self.llm_client.evaluate_importance(content).await.unwrap_or(0.5);

    // åŠ æƒæ±‚å’Œ
    0.2 * length_score +
    0.2 * keyword_density +
    0.15 * user_specificity +
    0.15 * recency_score +
    0.3 * llm_score
}
```

#### é‡å¤æ£€æµ‹ç®—æ³•

- **ç²¾ç¡®åŒ¹é…**ï¼šSHA-256(content) â†’ å¿«é€Ÿè¿‡æ»¤
- **è¯­ä¹‰å»é‡**ï¼ˆå¯é€‰ï¼‰ï¼šå¯¹ç›¸ä¼¼åµŒå…¥å‘é‡ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ > 0.95ï¼‰è¿›è¡ŒäºŒæ¬¡æ¯”å¯¹ï¼Œé¿å…â€œåŒä¹‰ä¸åŒè¯â€é‡å¤

### æ•°æ®ç»“æ„è®¾è®¡

#### Memory å®ä½“ï¼ˆæ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼‰

```rust
#[derive(Serialize, Deserialize, Debug)]
pub struct Memory {
    pub id: String, // UUID
    pub content: String,
    pub embedding: Vec<f32>, // 1536ç»´
    pub metadata: MemoryMetadata,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Serialize, Deserialize, Debug)]
pub struct MemoryMetadata {
    pub user_id: Option<String>,
    pub agent_id: Option<String>,
    pub run_id: Option<String>,
    pub actor_id: Option<String>,
    pub role: Option<String>,
    pub memory_type: MemoryType,
    pub hash: String, // SHA-256 of content
    pub importance_score: f32, // 0.0 ~ 1.0
    pub entities: Vec<String>, // å®ä½“è¯†åˆ«ç»“æœ
    pub topics: Vec<String>, // ä¸»é¢˜æå–ç»“æœ
    pub custom: HashMap<String, Value>, // æ‰©å±•å­—æ®µ
}
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–ç‚¹ | å®ç°æ–¹å¼ | æ•ˆæœ |
|--------|----------|------|
| **LLMè°ƒç”¨æ‰¹å¤„ç†** | å¯¹å¤šä¸ªè®°å¿†è¯·æ±‚åˆå¹¶ä¸ºä¸€æ¬¡LLMè°ƒç”¨ï¼ˆå¦‚æ‰¹é‡åˆ†ç±»ï¼‰ | å‡å°‘ç½‘ç»œå¼€é”€ï¼Œæå‡ååé‡ |
| **å‘é‡æŸ¥è¯¢ç¼“å­˜** | å¯¹é«˜é¢‘æŸ¥è¯¢ï¼ˆå¦‚â€œç”¨æˆ·åå¥½â€ï¼‰ç¼“å­˜ç»“æœï¼ˆå¾…å®ç°ï¼‰ | é™ä½Qdrantè´Ÿè½½ï¼Œå“åº”<10ms |
| **å¼‚æ­¥éé˜»å¡** | æ‰€æœ‰I/Oæ“ä½œä½¿ç”¨ `async/await`ï¼Œé¿å…çº¿ç¨‹é˜»å¡ | å•èŠ‚ç‚¹æ”¯æŒ1000+å¹¶å‘è¯·æ±‚ |
| **å†…å­˜å¤ç”¨** | ä½¿ç”¨ `Arc<str>` å…±äº«å†…å®¹å­—ç¬¦ä¸²ï¼Œé¿å…æ‹·è´ | å‡å°‘GCå‹åŠ› |
| **Qdrantç´¢å¼•ä¼˜åŒ–** | å¯ç”¨HNSW + é‡åŒ–ï¼ˆPQï¼‰ | å­˜å‚¨ç©ºé—´å‡å°‘40%ï¼Œæœç´¢é€Ÿåº¦æå‡30% |
| **æ—¥å¿—å¼‚æ­¥è¾“å‡º** | `tracing` ä½¿ç”¨ `tokio` å¼‚æ­¥å†™å…¥æ–‡ä»¶ | é¿å…æ—¥å¿—é˜»å¡ä¸»æµç¨‹ |

---

## 7. éƒ¨ç½²æ¶æ„ (Deployment Architecture)

### è¿è¡Œç¯å¢ƒè¦æ±‚

| ç»„ä»¶ | è¦æ±‚ |
|------|------|
| **æ“ä½œç³»ç»Ÿ** | Linuxï¼ˆæ¨èï¼‰ã€macOSã€Windows 10+ |
| **Rustç¯å¢ƒ** | Rust 1.75+ï¼ŒCargoå·¥ä½œåŒº |
| **å†…å­˜** | â‰¥ 2GBï¼ˆCLIï¼‰ï¼Œâ‰¥ 8GBï¼ˆæœåŠ¡æ¨¡å¼ï¼‰ |
| **ç½‘ç»œ** | å¯è®¿é—®LLMæœåŠ¡ï¼ˆOpenAIï¼‰ã€QdrantæœåŠ¡ |
| **Qdrant** | 1.8+ï¼Œå•èŠ‚ç‚¹æˆ–é›†ç¾¤ï¼Œå¯ç”¨HTTPS |
| **LLMæœåŠ¡** | OpenAI API Key æˆ–å…¼å®¹APIï¼ˆå¦‚Ollamaã€Local LLMï¼‰ |

### éƒ¨ç½²æ‹“æ‰‘ç»“æ„

```mermaid
graph LR
    subgraph "ç”¨æˆ·ç«¯"
        A[å¼€å‘è€…CLI] --> B[cortex-mem-cli]
        C[AIæ¡†æ¶RIG] --> D[cortex-mem-mcp]
        E[Webå‰ç«¯] --> F[cortex-mem-service]
        G[TUIç»ˆç«¯] --> H[examples/cortex-mem-tars]
    end

    subgraph "æœåŠ¡ç«¯"
        B --> I[cortex-mem-core]
        D --> I
        F --> I
        H --> I
        I --> J[cortex-mem-config]
        I --> K[Qdrant]
        I --> L[LLMæœåŠ¡]
    end

    style A fill:#e8f5e8,stroke:#333
    style C fill:#e8f5e8,stroke:#333
    style E fill:#e8f5e8,stroke:#333
    style G fill:#e8f5e8,stroke:#333
    style I fill:#d4edda,stroke:#333
    style J fill:#d4edda,stroke:#333
    style K fill:#bbf,stroke:#333
    style L fill:#f9f,stroke:#333

    classDef client fill:#e8f5e8,stroke:#333;
    classDef server fill:#d4edda,stroke:#333;
    classDef storage fill:#bbf,stroke:#333;
    classDef external fill:#f9f,stroke:#333;

    class A,C,E,G client
    class I,J server
    class K storage
    class L external
```

### æ‰©å±•æ€§è®¾è®¡

| æ‰©å±•ç»´åº¦ | æ‰©å±•ç­–ç•¥ |
|----------|----------|
| **æ¥å…¥æ–¹å¼** | æ–°å¢æ¥å…¥å±‚åªéœ€å®ç° `MemoryManager` æ¥å£ï¼Œå¦‚ï¼šgRPCã€WebSocketã€GraphQL |
| **å‘é‡æ•°æ®åº“** | å®ç° `VectorStore` traitï¼Œæ”¯æŒ Pineconeã€Weaviateã€Milvus |
| **LLMæä¾›å•†** | å®ç° `LLMClient` traitï¼Œæ”¯æŒ Anthropicã€Google Geminiã€æœ¬åœ°æ¨¡å‹ï¼ˆLlama.cppï¼‰ |
| **ä¼˜åŒ–ç­–ç•¥** | æ–°å¢ `OptimizationStrategy` æšä¸¾å˜ä½“ï¼Œå¦‚ `AutoArchive`ã€`PriorityBoost` |
| **å­˜å‚¨å®¹é‡** | Qdrantæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œcortex-memå¯æ°´å¹³æ‰©å±•å¤šä¸ªå®ä¾‹ï¼Œå…±äº«åŒä¸€Qdrant |
| **ç¼“å­˜å±‚** | å¯å¼•å…¥ Redis ç¼“å­˜é«˜é¢‘è®°å¿†ï¼Œé™ä½Qdrantå‹åŠ› |

### ç›‘æ§ä¸è¿ç»´

| ç›‘æ§é¡¹ | å®ç°æ–¹å¼ | å·¥å…·å»ºè®® |
|--------|----------|----------|
| **å¥åº·æ£€æŸ¥** | `/health` HTTPç«¯ç‚¹ï¼Œè¿”å› `{status: "ok", qdrant: true, llm: true}` | Prometheus + Blackbox Exporter |
| **æ€§èƒ½æŒ‡æ ‡** | `tracing` è¾“å‡º `duration`ã€`count`ã€`error` æ ‡ç­¾ | Grafana + Loki + Prometheus |
| **æ—¥å¿—èšåˆ** | JSONæ ¼å¼æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œç”±Fluentd/Vectoræ”¶é›† | ELK Stack æˆ– Grafana Loki |
| **å†…å­˜ç›‘æ§** | `tokio-console` + `pprof` é‡‡æ · | `cargo flamegraph` åˆ†æçƒ­ç‚¹ |
| **é…ç½®çƒ­æ›´æ–°** | æ”¯æŒ `SIGHUP` é‡è½½é…ç½®æ–‡ä»¶ï¼ˆå¾…å®ç°ï¼‰ | `watchdog` + `notify` crate |
| **è‡ªåŠ¨åŒ–ä¼˜åŒ–** | Kubernetes CronJob è°ƒç”¨ `cortex-mem-cli optimize` | æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œ |

> **è¿ç»´å»ºè®®**ï¼š
> - ä½¿ç”¨ `docker-compose` å¿«é€Ÿéƒ¨ç½²å¼€å‘ç¯å¢ƒ
> - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Helm Chart éƒ¨ç½²åˆ°K8s
> - é…ç½® `config.toml` ä¸å¯†é’¥é€šè¿‡Secretsç®¡ç†ï¼ˆå¦‚Vaultï¼‰
> - å»ºè®®å¼€å¯Qdrantçš„è‡ªåŠ¨å¤‡ä»½ä¸å¿«ç…§

---

## æ¶æ„æ´å¯Ÿæ€»ç»“

### âœ… **æ‰©å±•æ€§è®¾è®¡äº®ç‚¹**
- **æ¥å£æŠ½è±¡**ï¼š`VectorStore`ã€`LLMClient`ã€`OptimizationStrategy` ä¸‰å¤§æ¥å£ä¸ºç³»ç»Ÿæä¾›æ— é™æ‰©å±•èƒ½åŠ›ã€‚
- **æ’ä»¶å¼æ¥å…¥**ï¼šCLIã€HTTPã€MCPã€TUIå‡ä¸ºç‹¬ç«‹å®¹å™¨ï¼Œå¯ç‹¬ç«‹éƒ¨ç½²æˆ–ç§»é™¤ã€‚
- **å­˜å‚¨æ— å…³**ï¼šæœªæ¥å¯æ— ç¼åˆ‡æ¢å‘é‡æ•°æ®åº“ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒé€»è¾‘ã€‚

### âš¡ **æ€§èƒ½ä¸å¯é æ€§è®¾è®¡**
- **å¼‚æ­¥éé˜»å¡**ï¼šRust + Tokio å®ç°é«˜å¹¶å‘ï¼Œå•æœºå¯æ”¯æ’‘åƒçº§QPSã€‚
- **ç†”æ–­ä¸é™çº§**ï¼šLLMå¤±è´¥æ—¶å¯é™çº§ä¸ºâ€œä»…å­˜å‚¨åŸå§‹å†…å®¹â€ï¼Œä¿éšœç³»ç»Ÿå¯ç”¨æ€§ã€‚
- **äº‹åŠ¡æ€§ä¼˜åŒ–**ï¼šä¼˜åŒ–å¼•æ“æ”¯æŒæ‰¹é‡æ“ä½œä¸åŸå­æ€§å›æ»šï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ã€‚

### ğŸ”’ **å®‰å…¨æ€§è®¾è®¡**
- **æ— è®¤è¯æœºåˆ¶**ï¼šå½“å‰æœªå®ç°ï¼Œä½†æ¶æ„é¢„ç•™æ¥å£ï¼ˆå¦‚ `metadata.user_id`ï¼‰ï¼Œå¯åç»­é›†æˆJWTæˆ–OAuth2ã€‚
- **å¯†é’¥ç®¡ç†**ï¼šLLM API Key é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼Œé¿å…ç¡¬ç¼–ç ã€‚
- **è¾“å…¥æ ¡éªŒ**ï¼šæ‰€æœ‰è¾“å…¥å†…å®¹è¿›è¡Œé•¿åº¦ä¸æ ¼å¼æ ¡éªŒï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»ã€‚

### ğŸš€ **æœªæ¥æ¼”è¿›å»ºè®®**
1. **å¼•å…¥ç¼“å­˜å±‚**ï¼šRedis ç¼“å­˜é«˜é¢‘è®°å¿†ï¼Œé™ä½Qdrantè´Ÿè½½ã€‚
2. **æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²**ï¼šå°† `MemoryManager` æ— çŠ¶æ€åŒ–ï¼Œéƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œå…±äº«Qdrantã€‚
3. **å¢åŠ AIé©±åŠ¨çš„è‡ªåŠ¨ä¼˜åŒ–**ï¼šä½¿ç”¨LLMåˆ†æä¼˜åŒ–æŠ¥å‘Šï¼Œè‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–ç­–ç•¥ã€‚
4. **æ„å»ºè®°å¿†å›¾è°±**ï¼šå°†è®°å¿†é—´å…³ç³»ï¼ˆå¦‚â€œç›¸å…³â€ã€â€œå†²çªâ€ï¼‰å»ºæ¨¡ä¸ºå›¾æ•°æ®åº“ï¼Œæ”¯æŒæ¨ç†ã€‚
5. **å¼€æ”¾æ’ä»¶API**ï¼šå…è®¸å¼€å‘è€…ç¼–å†™è‡ªå®šä¹‰â€œè®°å¿†å¤„ç†å™¨â€ï¼ˆå¦‚æƒ…æ„Ÿåˆ†æã€æ³•å¾‹æ¡æ¬¾æå–ï¼‰ã€‚

---

> **æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-12-08 06:30:30 (UTC)  
> **æ—¶é—´æˆ³**ï¼š1765175430  
> **ç‰ˆæœ¬**ï¼šv1.0  
> **ä½œè€…**ï¼šç³»ç»Ÿæ¶æ„å›¢é˜Ÿ

æœ¬æ¶æ„æ–‡æ¡£ä¸ºcortex-memç³»ç»Ÿæä¾›å®Œæ•´ã€æ·±å…¥ã€å¯æ‰§è¡Œçš„æ¶æ„è“å›¾ï¼Œé€‚ç”¨äºå¼€å‘ã€è¿ç»´ã€æŠ€æœ¯è¯„å®¡ä¸æ–°æˆå‘˜åŸ¹è®­ï¼Œæ˜¯ç³»ç»Ÿé•¿æœŸæ¼”è¿›çš„åŸºçŸ³ã€‚